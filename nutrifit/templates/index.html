<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NutriFit - AI Nutrition & Workout Assistant</title>
    <style>
        /* ===== CSS Variables ===== */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #a5b4fc;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 12px;
            --radius-lg: 16px;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 12px;
            --spacing-lg: 16px;
            --spacing-xl: 20px;
            --spacing-2xl: 24px;
        }

        /* ===== Reset & Base ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #fef3c7 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            padding-bottom: 80px;
            position: relative;
            /* Space for bottom nav */
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                url('data:image/svg+xml,<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><circle cx="30" cy="30" r="1.5" fill="rgba(99,102,241,0.08)"/></svg>'),
                url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="2" fill="rgba(139,92,246,0.05)"/></svg>');
            background-size: 60px 60px, 100px 100px;
            background-position: 0 0, 30px 30px;
            pointer-events: none;
            z-index: 0;
        }

        /* ===== Layout ===== */
        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 1;
        }

        .header-wrapper {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
            position: relative;
            overflow: hidden;
        }

        .header-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .header {
            max-width: 600px;
            margin: 0 auto;
            color: white;
            padding: var(--spacing-xl) var(--spacing-lg);
            text-align: center;
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .header-logo {
            font-size: 2rem;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* ===== Tabs Content ===== */
        .tab-content {
            display: none;
            padding: var(--spacing-lg);
            animation: fadeIn 0.2s ease-in;
            position: relative;
            min-height: calc(100vh - 140px);
        }

        .tab-content.active {
            display: block;
        }

        /* Tab Background Images */
        #profile {
            background: 
                linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%),
                url('https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=800&q=80') center/cover no-repeat;
        }

        #meal {
            background: 
                linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%),
                url('https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=800&q=80') center/cover no-repeat;
        }

        #workout {
            background: 
                linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%),
                url('https://images.unsplash.com/photo-1534438327276-14e5300c3a48?w=800&q=80') center/cover no-repeat;
        }

        #shopping {
            background: 
                linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%),
                url('https://images.unsplash.com/photo-1542838132-92c53300491e?w=800&q=80') center/cover no-repeat;
        }

        #progress {
            background: 
                linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%),
                url('https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=800&q=80') center/cover no-repeat;
        }

        #chatbot {
            background: 
                linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.85) 100%),
                url('https://images.unsplash.com/photo-1531746790731-6c087fecd65a?w=800&q=80') center/cover no-repeat;
        }

        .tab-content > * {
            position: relative;
            z-index: 1;
        }

        /* ===== Screen Navigation ===== */
        .screen {
            display: none;
            animation: fadeIn 0.2s ease-in;
        }

        .screen.active {
            display: block;
        }

        .screen-header {
            display: flex;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border);
        }

        .screen-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            flex: 1;
        }

        .btn-back {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: var(--spacing-sm);
            margin-right: var(--spacing-md);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            transition: background 0.2s;
        }

        .btn-back:hover {
            background: var(--bg);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== Modal/Popup ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            padding: 20px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: modalSlideIn 0.3s ease-out;
            position: relative;
            border: 1px solid var(--border);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, #8b5cf6 50%, #ec4899 100%);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            color: var(--text-primary);
        }

        .instructions-list {
            list-style: decimal;
            padding-left: var(--spacing-xl);
            margin: var(--spacing-md) 0;
        }

        .instructions-list li {
            margin-bottom: var(--spacing-sm);
            line-height: 1.6;
        }

        /* ===== Chatbot Styles ===== */
        .chat-container {
            background: linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
            position: relative;
        }

        .chat-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(to bottom, rgba(99, 102, 241, 0.02), transparent);
            pointer-events: none;
        }

        .chat-message {
            margin-bottom: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            animation: messageSlide 0.3s ease-out;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-message.user {
            align-items: flex-end;
        }

        .chat-message.assistant {
            align-items: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            margin-bottom: var(--spacing-xs);
            box-shadow: var(--shadow-sm);
        }

        .chat-message.user .message-avatar {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        }

        .chat-message.assistant .message-avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .message-bubble {
            max-width: 85%;
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius-lg);
            line-height: 1.6;
            word-wrap: break-word;
            box-shadow: var(--shadow-sm);
            position: relative;
        }

        .chat-message.user .message-bubble {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .chat-message.assistant .message-bubble {
            background: var(--surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            border-bottom-left-radius: 6px;
        }

        .message-bubble ul {
            margin: var(--spacing-sm) 0;
            padding-left: var(--spacing-xl);
        }

        .message-bubble li {
            margin-bottom: var(--spacing-xs);
        }

        .message-bubble strong {
            font-weight: 600;
            color: inherit;
        }

        /* Message content styling */
        .message-content {
            line-height: 1.7;
        }

        .message-content .meal-day {
            background: var(--bg);
            padding: var(--spacing-md);
            border-radius: var(--radius);
            margin: var(--spacing-sm) 0;
            border-left: 3px solid var(--primary);
        }

        .message-content .meal-emoji {
            font-size: 1.25rem;
            margin-right: var(--spacing-xs);
        }

        .btn-quick {
            padding: var(--spacing-md) var(--spacing-lg);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .btn-quick::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .btn-quick:hover::before {
            left: 100%;
        }

        .btn-quick:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, #e0e7ff 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-quick:active {
            transform: translateY(0);
        }

        .btn-quick:focus {
            outline: none;
        }

        .btn-quick:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        @media (max-width: 480px) {
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }
        }

        .typing-indicator {
            display: flex;
            gap: 6px;
            padding: var(--spacing-md);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            animation: typing 1.4s infinite;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-12px);
                opacity: 1;
            }
        }

        /* Chat input area */
        .chat-input-wrapper {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            border: 2px solid var(--border);
            box-shadow: var(--shadow-md);
            transition: border-color 0.2s;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .chat-input-form {
            display: flex;
            gap: var(--spacing-sm);
            align-items: flex-end;
        }

        .chat-input-field {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 0.9375rem;
            padding: var(--spacing-sm);
            outline: none;
            color: var(--text-primary);
            resize: none;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.5;
            font-family: inherit;
            overflow-y: auto;
        }

        .chat-input-field::placeholder {
            color: var(--text-secondary);
        }

        .chat-send-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            padding: var(--spacing-md) var(--spacing-lg);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .chat-send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .chat-send-btn:active {
            transform: translateY(0);
        }

        /* Welcome card */
        .chat-welcome {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #86efac;
            border-radius: var(--radius-lg);
            padding: var(--spacing-xl);
            text-align: center;
            margin-bottom: var(--spacing-lg);
            position: relative;
            overflow: hidden;
        }

        .chat-welcome::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(134, 239, 172, 0.2) 0%, transparent 50%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        @keyframes pulse-subtle {
            0%, 100% { transform: scale(1); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
            50% { transform: scale(1.02); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        }

        .chat-welcome > * {
            position: relative;
            z-index: 1;
        }

        .chat-welcome-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .chat-welcome-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #166534;
            margin-bottom: var(--spacing-sm);
        }

        .chat-welcome-text {
            color: #15803d;
            line-height: 1.6;
        }

        /* ===== Bottom Navigation ===== */
        .bottom-nav-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.08);
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .bottom-nav {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            justify-content: space-around;
            padding: var(--spacing-xs) 0 calc(var(--spacing-xs) + env(safe-area-inset-bottom));
            background: var(--surface);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-xs) var(--spacing-xs);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.7rem;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: var(--radius);
            margin: 0 2px;
            position: relative;
            min-width: 0;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 0 0 3px 3px;
            transition: width 0.2s ease;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        .nav-item::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0;
            background: linear-gradient(to top, rgba(99, 102, 241, 0.05), transparent);
            transition: height 0.2s ease;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active::before {
            width: 60%;
        }

        .nav-item.active::after {
            height: 100%;
        }

        .nav-item:active {
            background: var(--bg);
            transform: scale(0.95);
        }

        .nav-item:focus {
            outline: none;
        }

        .nav-item:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: -2px;
        }

        .nav-item-icon {
            font-size: 1.5rem;
            margin-bottom: 2px;
            transition: transform 0.2s ease;
        }

        .nav-item.active .nav-item-icon {
            transform: scale(1.1);
        }

        .nav-item-label {
            font-size: 0.65rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .nav-item.active .nav-item-icon {
            transform: scale(1.05);
        }

        /* ===== Cards ===== */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            overflow: hidden;
            min-width: 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-with-image {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .card-with-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.98) 100%);
            z-index: 0;
        }

        .card > * {
            position: relative;
            z-index: 1;
        }

        .card-header {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .card-icon {
            font-size: 1.5rem;
        }

        /* ===== Buttons ===== */
        .btn {
            width: 100%;
            padding: var(--spacing-lg) var(--spacing-xl);
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: var(--spacing-md);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 0.875rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #7c3aed 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .btn:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2) !important;
            background: linear-gradient(135deg, var(--primary-dark) 0%, #7c3aed 100%) !important;
        }

        .btn:focus {
            outline: none;
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }

        .btn:not(:hover):not(:active):not(:focus) {
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            transform: translateY(0);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn > * {
            position: relative;
            z-index: 1;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            box-shadow: 0 8px 20px rgba(100, 116, 139, 0.4);
        }

        .btn-group {
            display: flex;
            gap: var(--spacing-md);
        }

        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        /* ===== Forms ===== */
        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--spacing-md);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9375rem;
            font-family: inherit;
            background: var(--surface);
            transition: all 0.2s;
            position: relative;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }

        .form-input:hover,
        .form-select:hover,
        .form-textarea:hover {
            border-color: var(--primary-light);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-help {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        /* ===== Checkboxes ===== */
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .checkbox-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.05), transparent);
            transition: left 0.4s ease;
        }

        .checkbox-item:hover {
            border-color: var(--primary-light);
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
        }

        .checkbox-item:hover::before {
            left: 100%;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* ===== Plan List ===== */
        .plan-list {
            margin-bottom: var(--spacing-lg);
        }

        .plan-item {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-md);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }

        .plan-item::before {
            content: 'üìã';
            position: absolute;
            top: 50%;
            right: -10px;
            transform: translateY(-50%);
            font-size: 60px;
            opacity: 0.05;
            transition: all 0.3s ease;
        }

        .plan-item:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.2);
            transform: translateX(4px);
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .plan-item:hover::before {
            right: 10px;
            opacity: 0.08;
        }

        .plan-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-xs);
        }

        .plan-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .plan-item-date {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .plan-item-meta {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        /* ===== Meal Cards (Collapsible) ===== */
        .meal-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-lg);
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .meal-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle at top right, rgba(99, 102, 241, 0.03) 0%, transparent 70%);
            pointer-events: none;
        }

        .meal-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            border-color: var(--primary-light);
        }

        .meal-card-header {
            padding: var(--spacing-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            cursor: pointer;
            background: linear-gradient(135deg, #fefefe 0%, #f9fafb 100%);
            border-bottom: 1px solid var(--border);
        }

        .meal-card-header:hover {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        .meal-icon {
            font-size: 3rem;
            flex-shrink: 0;
            filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.1));
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            padding: var(--spacing-md);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 70px;
            height: 70px;
            position: relative;
            overflow: hidden;
        }

        .meal-icon::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
        }

        .meal-info {
            flex: 1;
            min-width: 0;
        }

        .meal-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .meal-macros {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        .meal-calories {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 24px;
            font-size: 0.875rem;
            font-weight: 700;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .meal-calories::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: translate(0, 0); }
            50% { transform: translate(10%, 10%); }
        }

        .meal-card-body {
            padding: 0 var(--spacing-md) var(--spacing-md);
            display: none;
        }

        .meal-card.expanded .meal-card-body {
            display: block;
        }

        .meal-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            line-height: 1.6;
        }

        .macro-summary {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            background: var(--bg);
            border-radius: var(--radius);
        }

        .macro-item {
            text-align: center;
            position: relative;
            padding: var(--spacing-sm);
            border-radius: var(--radius);
            transition: all 0.2s ease;
        }

        .macro-item:hover {
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
        }

        .macro-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: block;
        }

        .macro-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
            display: block;
        }

        .ingredients-list {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
        }

        .ingredient-tag {
            background: var(--bg);
            color: var(--text-primary);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: 16px;
            font-size: 0.8125rem;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .ingredient-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.1), transparent);
            transition: left 0.4s ease;
        }

        .ingredient-tag:hover {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-color: var(--primary-light);
            transform: translateY(-1px);
        }

        .ingredient-tag:hover::before {
            left: 100%;
        }

        .meal-actions {
            display: flex;
            gap: var(--spacing-md);
            padding-top: var(--spacing-md);
            border-top: 1px solid var(--border);
        }

        .btn-accept,
        .btn-reject {
            flex: 1;
            padding: var(--spacing-md);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-accept {
            background: var(--success);
            color: white;
        }

        .btn-accept:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-reject {
            background: var(--bg);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-reject:hover {
            background: #fee2e2;
            color: var(--error);
            border-color: var(--error);
        }

        /* ===== Daily Totals ===== */
        .daily-totals {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            margin-top: var(--spacing-lg);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
        }

        .daily-totals::before {
            content: 'üìä';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 120px;
            opacity: 0.1;
            transform: rotate(15deg);
        }

        .daily-totals::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.1), transparent);
        }

        .daily-totals > * {
            position: relative;
            z-index: 1;
        }

        .daily-totals-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
            text-align: center;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
        }

        .total-item {
            text-align: center;
        }

        .total-value {
            font-size: 1.5rem;
            font-weight: 700;
            display: block;
        }

        .total-label {
            font-size: 0.75rem;
            opacity: 0.9;
            margin-top: var(--spacing-xs);
        }

        /* ===== Weekly Plan Cards ===== */
        .day-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border: 2px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 0;
            margin-bottom: var(--spacing-xl);
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            position: relative;
        }

        .day-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .day-card:hover::after {
            opacity: 1;
        }

        .day-header {
            font-weight: 700;
            font-size: 1.125rem;
            color: white;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: var(--spacing-lg);
            margin: 0;
            border: none;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            position: relative;
            overflow: hidden;
        }

        .day-header::before {
            content: "üìÖ";
            font-size: 1.5rem;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .day-header::after {
            content: '';
            position: absolute;
            top: 0;
            right: -50px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        }

        .meal-summary {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-lg);
            background: white;
            transition: all 0.2s ease;
            margin: var(--spacing-md);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .meal-summary:hover {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .meal-summary:last-child {
            margin-bottom: var(--spacing-md);
        }

        .meal-summary-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }

        .meal-summary-calories {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ===== Workout Cards ===== */
        .workout-card {
            background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
            border: 2px solid #fbbf24;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
            box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .workout-card::before {
            content: 'üí™';
            position: absolute;
            top: -20px;
            right: -20px;
            font-size: 120px;
            opacity: 0.05;
            transform: rotate(-15deg);
            pointer-events: none;
        }

        .workout-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.3);
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-lg);
            padding-bottom: var(--spacing-md);
            border-bottom: 2px solid #fde68a;
        }

        .workout-name {
            font-weight: 700;
            font-size: 1.125rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .workout-name::before {
            content: "üí™";
            font-size: 1.5rem;
        }

        .workout-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: var(--spacing-sm) var(--spacing-lg);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            position: relative;
            overflow: hidden;
        }

        .workout-badge::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            animation: badge-shine 3s ease-in-out infinite;
        }

        @keyframes badge-shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .exercise-item {
            padding: var(--spacing-lg);
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-radius: var(--radius-lg);
            margin-bottom: var(--spacing-md);
            border: 2px solid #fde68a;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .exercise-item::before {
            content: '';
            position: absolute;
            top: 0;
            right: -50px;
            width: 100px;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(251, 191, 36, 0.1));
            transform: skewX(-20deg);
            transition: right 0.4s ease;
        }

        .exercise-item:hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            transform: translateX(4px);
        }

        .exercise-item:hover::before {
            right: 100%;
        }

        .exercise-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .exercise-name::before {
            content: "üèãÔ∏è";
            font-size: 1.25rem;
        }

        .exercise-details {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* ===== Shopping List ===== */
        .shopping-category {
            margin-bottom: var(--spacing-lg);
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
        }

        .category-header {
            font-weight: 700;
            font-size: 1rem;
            color: white;
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, var(--primary) 0%, #8b5cf6 100%);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .category-header::before {
            content: 'üì¶';
        }

        .shopping-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-sm) var(--spacing-md);
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-xs);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .shopping-item:last-child {
            margin-bottom: 0;
        }

        .shopping-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .shopping-item:hover {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            transform: translateX(2px);
            border-color: var(--primary-light);
        }

        .shopping-item:hover::before {
            opacity: 1;
        }

        .shopping-item-name {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .shopping-item-quantity {
            font-size: 0.8rem;
            color: white;
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            padding: 2px 8px;
            border-radius: 12px;
            margin-right: var(--spacing-sm);
            font-weight: 500;
        }

        .shopping-actions {
            display: flex;
            gap: var(--spacing-xs);
        }

        .shopping-actions button {
            font-size: 0.7rem !important;
            padding: 4px 8px !important;
        }

        /* ===== Progress ===== */
        .progress-summary {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .progress-stat {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: var(--spacing-md);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .progress-stat::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
        }

        .progress-stat:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-light);
        }

        .progress-stat > * {
            position: relative;
            z-index: 1;
        }

        .progress-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .progress-stat-label {
            font-size: 0.8125rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }

        /* ===== Status Badges ===== */
        .status-badge {
            display: inline-block;
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            animation: fadeIn 0.3s ease-in;
        }

        .status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: status-slide 2s ease-in-out infinite;
        }

        @keyframes status-slide {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .status-accepted {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #86efac;
        }

        .status-rejected {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* ===== Loading & Results ===== */
        .loading {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-2xl);
            color: var(--text-secondary);
            position: relative;
        }

        .empty-state::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 0;
        }

        .empty-state > * {
            position: relative;
            z-index: 1;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.7;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .empty-state-text {
            font-size: 0.875rem;
            line-height: 1.6;
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: var(--spacing-md);
            border-radius: var(--radius);
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .error::before {
            content: "‚ö†Ô∏è";
            font-size: 1.25rem;
        }

        .result {
            margin-top: var(--spacing-lg);
        }

        /* ===== Manual Entry Card ===== */
        .manual-entry-card {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fbbf24;
            border-radius: var(--radius-lg);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }

        .manual-entry-card h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: var(--spacing-md);
        }

        /* ===== Toast Notifications ===== */
        .toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--surface);
            color: var(--text-primary);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            max-width: 90%;
            min-width: 200px;
            animation: slideDown 0.3s ease-out;
            border: 1px solid var(--border);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .toast.success {
            border-left: 4px solid var(--success);
            background: linear-gradient(135deg, rgba(240, 253, 244, 0.95) 0%, rgba(255, 255, 255, 0.95) 100%);
        }

        .toast.success::before {
            content: '‚úì';
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            width: 24px;
            height: 24px;
            background: var(--success);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .toast.info {
            border-left: 4px solid var(--primary);
            background: linear-gradient(135deg, rgba(240, 249, 255, 0.95) 0%, rgba(255, 255, 255, 0.95) 100%);
        }

        .toast.info::before {
            content: '‚Ñπ';
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            width: 24px;
            height: 24px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .toast.error {
            border-left: 4px solid var(--error);
            background: linear-gradient(135deg, rgba(254, 242, 242, 0.95) 0%, rgba(255, 255, 255, 0.95) 100%);
        }

        .toast.error::before {
            content: '‚úï';
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            width: 24px;
            height: 24px;
            background: var(--error);
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ===== Save Plan Button Styles ===== */
        .plan-save-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 2px solid var(--border);
        }

        .btn-save-plan {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: var(--radius);
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .btn-save-plan:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }

        .btn-save-plan:active {
            transform: translateY(0);
        }

        .btn-save-plan.saving {
            opacity: 0.7;
            cursor: wait;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .btn-save-plan.saved {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            cursor: not-allowed;
            opacity: 0.8;
        }

        .btn-save-plan.saved:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
        }

        .btn-regenerate {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            color: var(--text-primary);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
        }

        .btn-regenerate:hover {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light) 0%, #e0e7ff 100%);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-regenerate:active {
            transform: translateY(0);
        }

        /* ===== Responsive ===== */
        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .tab-content {
                padding: var(--spacing-md);
            }

            .totals-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: var(--spacing-sm);
            }

            .total-value {
                font-size: 1.25rem;
            }

            .plan-save-actions {
                flex-direction: column;
            }

            .btn-save-plan,
            .btn-regenerate {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Header -->
    <div class="header-wrapper">
        <div class="header">
            <h1><span class="header-logo">ü•ó</span>NutriFit</h1>
            <p>‚ú® AI Nutrition & Workout Assistant ‚ú®</p>
        </div>
    </div>

    <div class="app-container">

        <!-- Profile Tab -->
        <div id="profile" class="tab-content active">
            <div class="card">
                <h2 class="card-header"><span class="card-icon">üë§</span>Your Profile</h2>
                <form id="profileForm">
                    <div class="form-group">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Age</label>
                        <input type="number" name="age" class="form-input" min="1" max="150" placeholder="e.g. 30"
                            required>
                        <span class="form-help">Your age in years</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Weight (kg)</label>
                        <input type="number" name="weight_kg" class="form-input" step="0.1" min="1"
                            placeholder="e.g. 70.5" required>
                        <span class="form-help">Your current weight in kilograms</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Height (cm)</label>
                        <input type="number" name="height_cm" class="form-input" min="1" placeholder="e.g. 175"
                            required>
                        <span class="form-help">Your height in centimeters</span>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Dietary Preferences</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="dietary_preferences" value="vegetarian">
                                <span>Vegetarian</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="dietary_preferences" value="vegan">
                                <span>Vegan</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="dietary_preferences" value="keto">
                                <span>Keto</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="dietary_preferences" value="gluten_free">
                                <span>Gluten-Free</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="dietary_preferences" value="dairy_free">
                                <span>Dairy-Free</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="dietary_preferences" value="high_protein">
                                <span>High Protein</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Fitness Goals</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item">
                                <input type="checkbox" name="fitness_goals" value="weight_loss">
                                <span>Weight Loss</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="fitness_goals" value="muscle_gain">
                                <span>Muscle Gain</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="fitness_goals" value="maintenance">
                                <span>Maintenance</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="fitness_goals" value="endurance">
                                <span>Endurance</span>
                            </label>
                            <label class="checkbox-item">
                                <input type="checkbox" name="fitness_goals" value="strength">
                                <span>Strength</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Allergies (comma-separated)</label>
                        <input type="text" name="allergies" class="form-input" placeholder="e.g. peanuts, shellfish">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pantry Items (comma-separated)</label>
                        <input type="text" name="pantry_items" class="form-input"
                            placeholder="e.g. rice, pasta, olive oil">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Available Equipment (comma-separated)</label>
                        <input type="text" name="available_equipment" class="form-input"
                            placeholder="e.g. dumbbells, resistance bands">
                    </div>
                    <button type="submit" class="btn">Save Profile</button>
                </form>
            </div>
        </div>

        <!-- Meals Tab -->
        <div id="meal" class="tab-content">
            <div class="card">
                <h2 class="card-header"><span class="card-icon">üçΩÔ∏è</span>Meal Plans</h2>
                <div class="plan-list" id="mealPlanList">
                    <div class="loading">Loading saved plans...</div>
                </div>
            </div>
            <div class="card" style="margin-bottom: var(--spacing-lg);">
                <div
                    style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-sm); min-width: 0;">
                    <button class="btn btn-secondary" onclick="changeMealWeek(-1)"
                        style="flex: 0 0 auto; width: auto; padding: var(--spacing-sm) var(--spacing-md); white-space: nowrap; min-width: 40px;">‚Üê</button>
                    <div
                        style="flex: 1; text-align: center; min-width: 0; padding: 0 var(--spacing-sm);">
                        <div id="mealWeekDisplay"
                            style="font-weight: 600; font-size: 0.875rem; word-wrap: break-word;">
                        </div>
                        <small style="color: var(--text-secondary); font-size: 0.75rem;">Week</small>
                    </div>
                    <button class="btn btn-secondary" onclick="changeMealWeek(1)"
                        style="flex: 0 0 auto; width: auto; padding: var(--spacing-sm) var(--spacing-md); white-space: nowrap; min-width: 40px;">‚Üí</button>
                </div>
                <input type="hidden" id="mealWeekSelector" value="" aria-label="Selected week start date">
            </div>
            <div class="btn-group">
                <button class="btn" onclick="generateWeeklyMeal()">‚ú® Generate Weekly Plan</button>
            </div>
            <div id="mealResult" class="result"></div>

        </div>

        <!-- Workouts Tab -->
        <div id="workout" class="tab-content">
            <!-- Workout Plans -->
            <div class="card">
                <h2 class="card-header"><span class="card-icon">üí™</span>Workout Plans</h2>
                <div class="plan-list" id="workoutPlanList">
                    <div class="loading">Loading saved plans...</div>
                </div>
                <div class="card" style="margin-bottom: var(--spacing-lg);">
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; gap: var(--spacing-sm); min-width: 0;">
                        <button class="btn btn-secondary" onclick="changeWorkoutWeek(-1)"
                            style="flex: 0 0 auto; width: auto; padding: var(--spacing-sm) var(--spacing-md); white-space: nowrap; min-width: 40px;">‚Üê</button>
                        <div
                            style="flex: 1; text-align: center; min-width: 0; padding: 0 var(--spacing-sm);">
                            <div id="workoutWeekDisplay"
                                style="font-weight: 600; font-size: 0.875rem; word-wrap: break-word;">
                            </div>
                            <small style="color: var(--text-secondary); font-size: 0.75rem;">Week</small>
                        </div>
                        <button class="btn btn-secondary" onclick="changeWorkoutWeek(1)"
                            style="flex: 0 0 auto; width: auto; padding: var(--spacing-sm) var(--spacing-md); white-space: nowrap; min-width: 40px;">‚Üí</button>
                    </div>
                    <input type="hidden" id="workoutWeekSelector" value="" aria-label="Selected week start date">
                </div>
                <div class="btn-group">
                    <button class="btn" onclick="generateWeeklyWorkout()">üí™ Generate Weekly Plan</button>
                </div>
                <div id="workoutResult" class="result"></div>
            </div>
        </div>

        <!-- Shopping Tab -->
        <div id="shopping" class="tab-content">
            <!-- Manual Entry -->
            <div class="card">
                <h2 class="card-header"><span class="card-icon">üõí</span>Add Shopping Item</h2>
                <form id="shoppingEntryForm" onsubmit="saveManualShopping(event); return false;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-sm);">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Item Name *</label>
                            <input type="text" id="shoppingItemName" class="form-input" required placeholder="e.g. Chicken breast, Milk, Apples">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category *</label>
                            <input type="text" id="shoppingCategory" class="form-input" list="categoryList" required placeholder="e.g. Produce">
                            <datalist id="categoryList"></datalist>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Quantity *</label>
                            <input type="number" id="shoppingQuantity" class="form-input" step="0.1" required placeholder="e.g. 2">
                        </div>
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">Unit *</label>
                            <select id="shoppingUnit" class="form-select" required>
                                <option value="">Select unit...</option>
                                <option value="pcs">pcs (pieces)</option>
                                <option value="kg">kg (kilograms)</option>
                                <option value="g">g (grams)</option>
                                <option value="lb">lb (pounds)</option>
                                <option value="oz">oz (ounces)</option>
                                <option value="L">L (liters)</option>
                                <option value="ml">ml (milliliters)</option>
                                <option value="cups">cups</option>
                                <option value="tbsp">tbsp (tablespoons)</option>
                                <option value="pack">pack</option>
                                <option value="bunch">bunch</option>
                                <option value="can">can</option>
                                <option value="bottle">bottle</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);">‚ûï Add to List</button>
                </form>
            </div>

            <!-- This Week's Shopping List -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <h2 class="card-header" style="margin-bottom: 0;"><span class="card-icon">üìù</span>This Week's List</h2>
                    <button class="btn btn-secondary" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.8rem; width: auto;" onclick="generateShoppingList()">üîÑ Refresh</button>
                </div>
                <div id="shoppingResult" class="result"></div>
            </div>

            <!-- Shopping History -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                    <h2 class="card-header" style="margin-bottom: 0;"><span class="card-icon">üìú</span>Shopping History</h2>
                    <button class="btn btn-secondary" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.8rem; width: auto;" onclick="loadShoppingHistory()">Load History</button>
                </div>
                <div id="shoppingHistory" class="result"></div>
            </div>
        </div>

        <!-- Progress Tab -->
        <div id="progress" class="tab-content">
            <div class="card">
                <h2 class="card-header"><span class="card-icon">üìä</span>Progress Tracking</h2>
                <p class="form-help" style="margin-bottom: var(--spacing-lg);">Log your daily progress. All fields are optional.</p>
                <form id="progressForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-md);">
                        <div class="form-group">
                            <label class="form-label">Weight (kg)</label>
                            <input type="number" name="weight_kg" class="form-input" step="0.1" placeholder="e.g. 70.5">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Calories Consumed</label>
                            <input type="number" name="calories_consumed" class="form-input" placeholder="e.g. 2000">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Workouts Completed</label>
                            <input type="number" name="workouts_completed" class="form-input" placeholder="e.g. 1" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Meals Followed</label>
                            <input type="number" name="meals_followed" class="form-input" placeholder="e.g. 3" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Energy Level (1-10)</label>
                            <input type="number" name="energy_rating" class="form-input" placeholder="e.g. 7" min="1" max="10">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Mood Rating (1-10)</label>
                            <input type="number" name="mood_rating" class="form-input" placeholder="e.g. 8" min="1" max="10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <textarea name="notes" class="form-textarea" placeholder="How did you feel today? Any achievements?" rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn">Log Progress</button>
                </form>
            </div>
            <div class="card">
                <h2 class="card-header">üìà Progress Summary</h2>
                <button class="btn btn-secondary" onclick="getProgressSummary()">View Summary</button>
                <div id="progressResult" class="result"></div>
            </div>
            <div class="card">
                <h2 class="card-header">üìÖ Progress History</h2>
                <button class="btn btn-secondary" onclick="loadProgressHistory()">Load History</button>
                <div id="progressHistory" class="result"></div>
            </div>
        </div>

        <!-- Chatbot Tab -->
        <div id="chatbot" class="tab-content">
            <!-- Welcome Card -->
            <div class="chat-welcome">
                <div class="chat-welcome-icon">ü§ñ‚ú®</div>
                <h3 class="chat-welcome-title">Your AI Nutrition & Fitness Coach</h3>
                <p class="chat-welcome-text">
                    I'm here to help you achieve your health goals with personalized meal plans, 
                    workout routines, and expert nutrition advice!
                </p>
            </div>

            <!-- Chat Messages Container -->
            <div class="card" style="padding: 0; overflow: hidden;">
                <div id="chatMessages" class="chat-container">
                    <div class="chat-message assistant">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-bubble">
                            <div class="message-content">
                                <strong>üëã Welcome to NutriFit!</strong><br><br>
                                I'm your personal AI assistant. I can help you with:
                                <ul style="margin: var(--spacing-md) 0; padding-left: var(--spacing-xl);">
                                    <li>üçΩÔ∏è <strong>Personalized Meal Plans</strong> - Tailored to your goals and preferences</li>
                                    <li>üí™ <strong>Custom Workout Routines</strong> - Designed for your fitness level</li>
                                    <li>ü•ó <strong>Nutrition Guidance</strong> - Expert answers to your questions</li>
                                    <li>‚úèÔ∏è <strong>Plan Modifications</strong> - Adjust meals and workouts anytime</li>
                                </ul>
                                <strong>Try asking me:</strong><br>
                                "I want a full meal plan with 2000 calories"<br>
                                "Create a 4-day workout plan for muscle gain"<br>
                                "What are good protein sources for vegans?"
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Action Buttons -->
            <div class="quick-actions-grid">
                <button class="btn-quick" onclick="sendQuickMessage('I want a full meal plan for this week')">
                    <span style="font-size: 1.5rem;">üçΩÔ∏è</span>
                    <div>
                        <div style="font-weight: 700;">Weekly Meal Plan</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">7-day personalized plan</div>
                    </div>
                </button>
                <button class="btn-quick" onclick="sendQuickMessage('Generate a workout plan for me')">
                    <span style="font-size: 1.5rem;">üí™</span>
                    <div>
                        <div style="font-weight: 700;">Workout Routine</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">Custom exercise plan</div>
                    </div>
                </button>
                <button class="btn-quick" onclick="sendQuickMessage('What should I eat for breakfast?')">
                    <span style="font-size: 1.5rem;">üç≥</span>
                    <div>
                        <div style="font-weight: 700;">Breakfast Ideas</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">Healthy morning meals</div>
                    </div>
                </button>
                <button class="btn-quick" onclick="sendQuickMessage('How much protein do I need daily?')">
                    <span style="font-size: 1.5rem;">‚ùì</span>
                    <div>
                        <div style="font-weight: 700;">Nutrition Q&A</div>
                        <div style="font-size: 0.75rem; opacity: 0.7;">Ask me anything</div>
                    </div>
                </button>
            </div>
            
            <!-- Chat Input -->
            <div class="chat-input-wrapper" style="margin-top: var(--spacing-lg);">
                <form id="chatForm" class="chat-input-form">
                    <textarea 
                        id="chatInput" 
                        class="chat-input-field" 
                        placeholder="Type your message here..." 
                        rows="1"
                        required
                    ></textarea>
                    <button type="submit" class="chat-send-btn">
                        Send üì§
                    </button>
                </form>
            </div>
        </div>

        <!-- Modal for Instructions/Details -->
        <div id="modalOverlay" class="modal-overlay" onclick="closeModal(event)">
            <div class="modal-content" onclick="event.stopPropagation()">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Details</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="modalBody">
                    <!-- Content will be inserted here -->
                </div>
            </div>
        </div>

    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav-wrapper">
        <div class="bottom-nav">
            <a href="#" class="nav-item active" onclick="showTab('profile'); return false;">
                <div class="nav-item-icon">üë§</div>
                <div class="nav-item-label">Profile</div>
            </a>
            <a href="#" class="nav-item" onclick="showTab('meal'); return false;">
                <div class="nav-item-icon">üçΩÔ∏è</div>
                <div class="nav-item-label">Meals</div>
            </a>
            <a href="#" class="nav-item" onclick="showTab('workout'); return false;">
                <div class="nav-item-icon">üí™</div>
                <div class="nav-item-label">Workouts</div>
            </a>
            <a href="#" class="nav-item" onclick="showTab('shopping'); return false;">
                <div class="nav-item-icon">üõí</div>
                <div class="nav-item-label">Shopping</div>
            </a>
            <a href="#" class="nav-item" onclick="showTab('progress'); return false;">
                <div class="nav-item-icon">üìä</div>
                <div class="nav-item-label">Progress</div>
            </a>
            <a href="#" class="nav-item" onclick="showTab('chatbot'); return false;">
                <div class="nav-item-icon">üí¨</div>
                <div class="nav-item-label">Chat</div>
            </a>
        </div>
    </div>

    <script>
        const API_BASE = '';

        // Tab Navigation
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');

            // Load data when switching tabs
            if (tabName === 'meal') {
                loadMealPlans();
            } else if (tabName === 'workout') {
                loadWorkoutPlans();
            } else if (tabName === 'shopping') {
                // Auto-generate shopping list when tab is shown
                generateShoppingList();
            }
        }

        // Helper Functions
        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = '<div class="loading">Loading...</div>';
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `<div class="error">${message}</div>`;
        }

        function safeToFixed(value, decimals = 1) {
            if (value === null || value === undefined || isNaN(value)) {
                return '0';
            }
            return Number(value).toFixed(decimals);
        }

        // Toast Notification
        let currentToast = null;
        
        function showToast(message, type = 'info') {
            // Remove existing toast if any
            if (currentToast) {
                currentToast.remove();
            }
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            currentToast = toast;

            // Auto-remove after 3 seconds unless it's a loading toast
            if (type !== 'loading') {
                setTimeout(() => {
                    if (currentToast === toast) {
                        toast.style.animation = 'slideDown 0.3s ease-out reverse';
                        setTimeout(() => {
                            toast.remove();
                            if (currentToast === toast) currentToast = null;
                        }, 300);
                    }
                }, 3000);
            }
            
            return toast;
        }
        
        function hideToast() {
            if (currentToast) {
                currentToast.style.animation = 'slideDown 0.3s ease-out reverse';
                setTimeout(() => {
                    if (currentToast) {
                        currentToast.remove();
                        currentToast = null;
                    }
                }, 300);
            }
        }

        // Load Plans for Selected Week
        async function loadMealPlansForWeek() {
            const weekStart = getWeekValue(currentMealWeek);
            const weekStartDate = new Date(weekStart);
            const weekEndDate = new Date(weekStartDate);
            weekEndDate.setDate(weekStartDate.getDate() + 6);

            try {
                const res = await fetch(`${API_BASE}/api/meal-plans`);
                const result = await res.json();
                const resultContainer = document.getElementById('mealResult');

                if (result.success && result.plans && result.plans.length > 0) {
                    // Filter plans for the selected week - must start on the Monday of this week
                    const weekPlans = result.plans.filter(plan => {
                        const planStart = new Date(plan.start_date);
                        // Normalize both dates to compare just the date part
                        const planStartStr = planStart.toISOString().split('T')[0];
                        return planStartStr === weekStart;
                    });

                    if (weekPlans.length > 0) {
                        // Load the first matching plan without auto-adjusting week
                        await loadMealPlan(weekPlans[0].id, false);
                    } else {
                        resultContainer.innerHTML = `<div style="padding: var(--spacing-lg); text-align: center; color: var(--text-secondary);">
                            <p>No meal plan found for this week.</p>
                            <p style="font-size: 0.875rem; margin-top: var(--spacing-sm);">Generate a plan for this week to get started.</p>
                        </div>`;
                    }
                } else {
                    const resultContainer = document.getElementById('mealResult');
                    resultContainer.innerHTML = `<div style="padding: var(--spacing-lg); text-align: center; color: var(--text-secondary);">
                        <p>No meal plans found.</p>
                        <p style="font-size: 0.875rem; margin-top: var(--spacing-sm);">Generate a plan to get started.</p>
                    </div>`;
                }
            } catch (error) {
                const resultContainer = document.getElementById('mealResult');
                resultContainer.innerHTML = `<div class="error">Error loading plans: ${error.message}</div>`;
            }
        }

        async function loadWorkoutPlansForWeek() {
            const weekStart = getWeekValue(currentWorkoutWeek);
            const weekStartDate = new Date(weekStart);
            const weekEndDate = new Date(weekStartDate);
            weekEndDate.setDate(weekStartDate.getDate() + 6);

            try {
                const res = await fetch(`${API_BASE}/api/workout-plans`);
                const result = await res.json();
                const resultContainer = document.getElementById('workoutResult');

                if (result.success && result.plans && result.plans.length > 0) {
                    // Filter plans for the selected week - must start on the Monday of this week
                    const weekPlans = result.plans.filter(plan => {
                        const planStart = new Date(plan.start_date);
                        // Normalize both dates to compare just the date part
                        const planStartStr = planStart.toISOString().split('T')[0];
                        return planStartStr === weekStart;
                    });

                    if (weekPlans.length > 0) {
                        // Load the first matching plan without auto-adjusting week
                        await loadWorkoutPlan(weekPlans[0].id, false);
                    } else {
                        resultContainer.innerHTML = `<div style="padding: var(--spacing-lg); text-align: center; color: var(--text-secondary);">
                            <p>No workout plan found for this week.</p>
                            <p style="font-size: 0.875rem; margin-top: var(--spacing-sm);">Generate a plan for this week to get started.</p>
                        </div>`;
                    }
                } else {
                    const resultContainer = document.getElementById('workoutResult');
                    resultContainer.innerHTML = `<div style="padding: var(--spacing-lg); text-align: center; color: var(--text-secondary);">
                        <p>No workout plans found.</p>
                        <p style="font-size: 0.875rem; margin-top: var(--spacing-sm);">Generate a plan to get started.</p>
                    </div>`;
                }
            } catch (error) {
                const resultContainer = document.getElementById('workoutResult');
                resultContainer.innerHTML = `<div class="error">Error loading plans: ${error.message}</div>`;
            }
        }

        // Load Plans
        async function loadMealPlans() {
            try {
                const res = await fetch(`${API_BASE}/api/meal-plans`);
                const result = await res.json();
                const listContainer = document.getElementById('mealPlanList');

                if (result.success && result.plans && result.plans.length > 0) {
                    listContainer.innerHTML = result.plans.map((plan, index) => {
                        const startDate = new Date(plan.start_date);
                        const endDate = plan.end_date ? new Date(plan.end_date) : startDate;
                        const duration = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                        const isWeekly = duration > 1;

                        let dateDisplay = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        if (isWeekly) {
                            dateDisplay = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                        }

                        const planType = 'Weekly Plan';

                        let timeInfo = 'Last updated: ';
                        if (plan.created_at) {
                            const updatedDate = new Date(plan.created_at * 1000);
                            const now = new Date();
                            const diffMs = now - updatedDate;
                            const diffMins = Math.floor(diffMs / 60000);
                            const diffHours = Math.floor(diffMs / 3600000);
                            const diffDays = Math.floor(diffMs / 86400000);

                            if (diffMins < 1) timeInfo += 'Just now';
                            else if (diffMins < 60) timeInfo += `${diffMins}m ago`;
                            else if (diffHours < 24) timeInfo += `${diffHours}h ago`;
                            else if (diffDays < 7) timeInfo += `${diffDays}d ago`;
                            else timeInfo += updatedDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                        } else {
                            timeInfo += 'Unknown';
                        }

                        const sourceIndicator = plan.source === 'ai_chat' ? '<span style="color: var(--success); font-size: 0.75rem; margin-left: var(--spacing-xs);">ü§ñ AI Chat</span>' : '';
                        
                        return `
                            <div class="plan-item" onclick="loadMealPlan('${plan.id}')">
                                <div class="plan-item-header">
                                    <span class="plan-item-name">${planType}${sourceIndicator}</span>
                                    <span class="plan-item-date">${dateDisplay}</span>
                                </div>
                                <div class="plan-item-meta">${timeInfo}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üçΩÔ∏è</div>
                            <div class="empty-state-title">No Meal Plans Yet</div>
                            <div class="empty-state-text">Create your first meal plan to get started on your nutrition journey!</div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('mealPlanList').innerHTML = '<div class="error">Error loading plans</div>';
            }
        }

        async function loadWorkoutPlans() {
            try {
                const res = await fetch(`${API_BASE}/api/workout-plans`);
                const result = await res.json();
                const listContainer = document.getElementById('workoutPlanList');

                if (result.success && result.plans && result.plans.length > 0) {
                    listContainer.innerHTML = result.plans.map((plan, index) => {
                        const startDate = new Date(plan.start_date);
                        const endDate = plan.end_date ? new Date(plan.end_date) : startDate;
                        const duration = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                        const isWeekly = duration > 1;

                        let dateDisplay = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        if (isWeekly) {
                            dateDisplay = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                        }

                        const planType = isWeekly ? 'Weekly' : 'Daily';

                        let timeInfo = '';
                        if (plan.created_at) {
                            const createdDate = new Date(plan.created_at * 1000);
                            const now = new Date();
                            const diffMs = now - createdDate;
                            const diffMins = Math.floor(diffMs / 60000);
                            const diffHours = Math.floor(diffMs / 3600000);
                            const diffDays = Math.floor(diffMs / 86400000);

                            if (diffMins < 1) timeInfo = ' ‚Ä¢ Just now';
                            else if (diffMins < 60) timeInfo = ` ‚Ä¢ ${diffMins}m ago`;
                            else if (diffHours < 24) timeInfo = ` ‚Ä¢ ${diffHours}h ago`;
                            else if (diffDays < 7) timeInfo = ` ‚Ä¢ ${diffDays}d ago`;
                            else timeInfo = ` ‚Ä¢ ${createdDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                        } else {
                            timeInfo = ` ‚Ä¢ Plan #${index + 1}`;
                        }

                        const sourceIndicator = plan.source === 'ai_chat' ? '<span style="color: var(--success); font-size: 0.75rem; margin-left: var(--spacing-xs);">ü§ñ AI Chat</span>' : '';
                        
                        return `
                            <div class="plan-item" onclick="loadWorkoutPlan('${plan.id}')">
                                <div class="plan-item-header">
                                    <span class="plan-item-name">${planType}${sourceIndicator}</span>
                                    <span class="plan-item-date">${dateDisplay}</span>
                                </div>
                                <div class="plan-item-meta">${plan.workout_days_per_week || 0} workout days${timeInfo}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üí™</div>
                            <div class="empty-state-title">No Workout Plans Yet</div>
                            <div class="empty-state-text">Generate your first workout plan and start building strength!</div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('workoutPlanList').innerHTML = '<div class="error">Error loading plans</div>';
            }
        }

        // Display Functions
        function displayMealPlan(plan, elementId) {
            const container = document.getElementById(elementId);
            const mealIcons = {
                breakfast: 'üç≥',
                lunch: 'üç±',
                dinner: 'üçΩÔ∏è',
                snack: 'üçé'
            };

            let html = '';

            if (plan.meals && plan.meals.length > 0) {
                plan.meals.forEach((meal, index) => {
                    const mealId = `meal-${index}`;
                    const icon = mealIcons[meal.type] || 'Meal';

                    html += `
                        <div class="meal-card" data-meal-id="${mealId}">
                            <div class="meal-card-header" onclick="toggleMealCard('${mealId}')">
                                <div class="meal-icon">${icon}</div>
                                <div class="meal-info">
                                    <div class="meal-name">${meal.name}</div>
                                    <div class="meal-macros">
                                        <span>P: ${safeToFixed(meal.protein)}g</span>
                                        <span>C: ${safeToFixed(meal.carbs)}g</span>
                                        <span>F: ${safeToFixed(meal.fat)}g</span>
                                    </div>
                                </div>
                                <div class="meal-calories">${meal.calories} kcal</div>
                            </div>
                            <div class="meal-card-body" id="body-${mealId}">
                                <div class="meal-description">${meal.description || ''}</div>
                                <div class="macro-summary">
                                    <div class="macro-item">
                                        <div class="macro-value">${safeToFixed(meal.protein)}g</div>
                                        <div class="macro-label">Protein</div>
                                    </div>
                                    <div class="macro-item">
                                        <div class="macro-value">${safeToFixed(meal.carbs)}g</div>
                                        <div class="macro-label">Carbs</div>
                                    </div>
                                    <div class="macro-item">
                                        <div class="macro-value">${safeToFixed(meal.fat)}g</div>
                                        <div class="macro-label">Fat</div>
                                    </div>
                                </div>
                                ${meal.ingredients && meal.ingredients.length > 0 ? `
                                    <div class="ingredients-list">
                                        ${meal.ingredients.map(ing => `<span class="ingredient-tag">${ing}</span>`).join('')}
                                    </div>
                                ` : ''}
                                <div class="meal-actions">
                                    <button class="btn-accept" onclick="acceptMeal('${mealId}', '${meal.type}')">Accept</button>
                                    <button class="btn-reject" onclick="rejectMeal('${mealId}', '${meal.type}')">Reject</button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // Calculate totals from meals
                let totalCarbs = 0;
                let totalFat = 0;
                if (plan.meals && plan.meals.length > 0) {
                    plan.meals.forEach(meal => {
                        totalCarbs += meal.carbs || 0;
                        totalFat += meal.fat || 0;
                    });
                }

                // Daily Totals
                if (plan.total_calories) {
                    html += `
                        <div class="daily-totals">
                            <div class="daily-totals-title">Daily Totals</div>
                            <div class="totals-grid">
                                <div class="total-item">
                                    <span class="total-value">${plan.total_calories}</span>
                                    <span class="total-label">Calories</span>
                                </div>
                                <div class="total-item">
                                    <span class="total-value">${safeToFixed(plan.total_protein || 0)}g</span>
                                    <span class="total-label">Protein</span>
                                </div>
                                <div class="total-item">
                                    <span class="total-value">${safeToFixed(totalCarbs)}g</span>
                                    <span class="total-label">Carbs</span>
                                </div>
                                <div class="total-item">
                                    <span class="total-value">${safeToFixed(totalFat)}g</span>
                                    <span class="total-label">Fat</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
        }

        function toggleMealCard(mealId) {
            const card = document.querySelector(`[data-meal-id="${mealId}"]`);
            card.classList.toggle('expanded');
        }

        function displayWeeklyMealPlan(plan, elementId) {
            const container = document.getElementById(elementId);
            
            const dayColors = [
                'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', // Monday - Red
                'linear-gradient(135deg, #f97316 0%, #ea580c 100%)', // Tuesday - Orange
                'linear-gradient(135deg, #eab308 0%, #ca8a04 100%)', // Wednesday - Yellow
                'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)', // Thursday - Green
                'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', // Friday - Blue
                'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)', // Saturday - Cyan
                'linear-gradient(135deg, #ec4899 0%, #db2777 100%)'  // Sunday - Pink
            ];
            
            const mealStyles = {
                breakfast: { label: 'Breakfast', gradient: 'linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%)' },
                lunch: { label: 'Lunch', gradient: 'linear-gradient(135deg, #34d399 0%, #10b981 100%)' },
                dinner: { label: 'Dinner', gradient: 'linear-gradient(135deg, #818cf8 0%, #6366f1 100%)' },
                snack: { label: 'Snack', gradient: 'linear-gradient(135deg, #f472b6 0%, #ec4899 100%)' }
            };
            
            let html = '';

            if (plan.days && plan.days.length > 0) {
                plan.days.forEach((day, dayIndex) => {
                    const dayOfWeek = new Date(day.date).getDay();
                    const colorIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    const dayColor = dayColors[colorIndex];
                    
                    let mealsHtml = '';
                    if (day.meals && day.meals.length > 0) {
                        day.meals.forEach((meal, mealIndex) => {
                            const style = mealStyles[meal.type] || { label: 'Meal', gradient: 'linear-gradient(135deg, #6b7280 0%, #4b5563 100%)' };
                            mealsHtml += '<div class="meal-summary" id="meal-' + plan.id + '-' + dayIndex + '-' + mealIndex + '" style="position: relative;">';
                            mealsHtml += '<div id="meal-display-' + plan.id + '-' + dayIndex + '-' + mealIndex + '" style="width: 100%;">';
                            mealsHtml += '<div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%;">';
                            mealsHtml += '<div style="flex: 1; padding-right: var(--spacing-sm);">';
                            mealsHtml += '<div class="meal-summary-name" style="font-weight: 500; margin-bottom: var(--spacing-xs); display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">';
                            mealsHtml += '<span class="meal-type-badge" style="background: ' + style.gradient + '; color: white; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; display: inline-flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">';
                            mealsHtml += style.label;
                            mealsHtml += '</span>';
                            mealsHtml += '<span style="color: var(--text-primary);">' + (meal.name || 'No meal') + '</span>';
                            mealsHtml += '</div>';
                            mealsHtml += '<div style="font-size: 0.75rem; color: var(--text-secondary);">';
                            mealsHtml += (meal.calories || 0) + ' kcal' + (meal.protein ? ' ‚Ä¢ ' + meal.protein + 'g protein' : '');
                            mealsHtml += '</div></div>';
                            mealsHtml += '<div style="display: flex; gap: var(--spacing-xs); flex-shrink: 0; margin-left: auto;">';
                            mealsHtml += '<button type="button" class="btn" style="padding: var(--spacing-xs) var(--spacing-sm); font-size: 0.75rem;" onclick="event.stopPropagation(); showMealInstructions(\'' + plan.id + '\', \'' + day.date + '\', \'' + meal.type + '\', ' + dayIndex + ', ' + mealIndex + ')" title="View Instructions">View</button>';
                            mealsHtml += '<button type="button" class="btn" style="padding: var(--spacing-xs) var(--spacing-sm); font-size: 0.75rem; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);" onclick="event.stopPropagation(); showMealEditForm(\'' + plan.id + '\', \'' + day.date + '\', \'' + meal.type + '\', ' + dayIndex + ', ' + mealIndex + ')" title="Edit">Edit</button>';
                            mealsHtml += '</div></div></div>';
                            mealsHtml += '<div id="meal-edit-' + plan.id + '-' + dayIndex + '-' + mealIndex + '" style="display: none;">';
                            mealsHtml += '<form onsubmit="saveMealEdit(event, \'' + plan.id + '\', \'' + day.date + '\', \'' + meal.type + '\', ' + dayIndex + ', ' + mealIndex + '); return false;">';
                            mealsHtml += '<div class="form-group"><label class="form-label">Meal Name *</label>';
                            mealsHtml += '<input type="text" id="edit-meal-name-' + plan.id + '-' + dayIndex + '-' + mealIndex + '" class="form-input" value="' + (meal.name || '') + '" required></div>';
                            mealsHtml += '<div class="form-group"><label class="form-label">Calories *</label>';
                            mealsHtml += '<input type="number" id="edit-meal-calories-' + plan.id + '-' + dayIndex + '-' + mealIndex + '" class="form-input" value="' + (meal.calories || 0) + '" required min="0"></div>';
                            mealsHtml += '<div class="form-group"><label class="form-label">Protein (g) *</label>';
                            mealsHtml += '<input type="number" id="edit-meal-protein-' + plan.id + '-' + dayIndex + '-' + mealIndex + '" class="form-input" value="' + (meal.protein || 0) + '" required min="0" step="0.1"></div>';
                            mealsHtml += '<div class="form-group"><label class="form-label">Carbs (g) *</label>';
                            mealsHtml += '<input type="number" id="edit-meal-carbs-' + plan.id + '-' + dayIndex + '-' + mealIndex + '" class="form-input" value="' + (meal.carbs || 0) + '" required min="0" step="0.1"></div>';
                            mealsHtml += '<div class="form-group"><label class="form-label">Fat (g) *</label>';
                            mealsHtml += '<input type="number" id="edit-meal-fat-' + plan.id + '-' + dayIndex + '-' + mealIndex + '" class="form-input" value="' + (meal.fat || 0) + '" required min="0" step="0.1"></div>';
                            mealsHtml += '<div style="display: flex; gap: var(--spacing-sm);">';
                            mealsHtml += '<button type="submit" class="btn" style="flex: 1;">Save</button>';
                            mealsHtml += '<button type="button" class="btn btn-secondary" style="flex: 1;" onclick="cancelMealEdit(\'' + plan.id + '\', ' + dayIndex + ', ' + mealIndex + ')">Cancel</button>';
                            mealsHtml += '</div></form></div></div>';
                        });
                    } else {
                        mealsHtml = '<div style="padding: var(--spacing-md); text-align: center; color: var(--text-secondary);">No meals planned</div>';
                    }
                    
                    html += '<div class="day-card">';
                    html += '<div class="day-header" style="background: ' + dayColor + ';">' + new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }) + '</div>';
                    html += mealsHtml;
                    html += '</div>';
                });
            }

            container.innerHTML = html;
        }

        // Screen Navigation
        function showScreen(screenId) {
            // Hide all screens in current tab
            const currentTab = document.querySelector('.tab-content.active');
            if (currentTab) {
                currentTab.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                const screen = currentTab.querySelector(`#${screenId}`);
                if (screen) {
                    screen.classList.add('active');
                }
            }
        }

        // Week management
        let currentMealWeek = 0; // 0 = current week, -1 = previous week, 1 = next week, etc.
        let currentWorkoutWeek = 0;
        let currentDisplayedMealPlanId = null; // Track which plan is currently displayed

        // Helper function to get Monday of a week offset from current week
        function getWeekStartDate(weekOffset = 0) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            // Calculate days to Monday (if today is Sunday, go back 6 days)
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(today);
            monday.setDate(today.getDate() + daysToMonday + (weekOffset * 7));
            return monday;
        }

        // Helper function to format week display
        function formatWeekDisplay(weekOffset) {
            const weekStart = getWeekStartDate(weekOffset);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 6);

            const startStr = weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const endStr = weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            if (weekOffset === 0) {
                return `This Week (${startStr} - ${endStr})`;
            } else if (weekOffset === -1) {
                return `Last Week (${startStr} - ${endStr})`;
            } else if (weekOffset === 1) {
                return `Next Week (${startStr} - ${endStr})`;
            } else {
                return `${startStr} - ${endStr}`;
            }
        }

        // Helper function to get week value for API
        function getWeekValue(weekOffset) {
            const weekStart = getWeekStartDate(weekOffset);
            // Format as YYYY-MM-DD in local timezone (not UTC)
            const year = weekStart.getFullYear();
            const month = String(weekStart.getMonth() + 1).padStart(2, '0');
            const day = String(weekStart.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Change meal week
        function changeMealWeek(delta) {
            currentMealWeek += delta;
            updateMealWeekDisplay();
            // Reset the displayed plan tracking to allow week navigation
            currentDisplayedMealPlanId = null;
            // Reload and filter plans for the selected week
            loadMealPlansForWeek();
        }

        // Change workout week
        function changeWorkoutWeek(delta) {
            currentWorkoutWeek += delta;
            updateWorkoutWeekDisplay();
            // Reload and filter plans for the selected week
            loadWorkoutPlansForWeek();
        }

        // Update meal week display
        function updateMealWeekDisplay() {
            const display = document.getElementById('mealWeekDisplay');
            const selector = document.getElementById('mealWeekSelector');
            if (display) {
                display.textContent = formatWeekDisplay(currentMealWeek);
            }
            if (selector) {
                selector.value = getWeekValue(currentMealWeek);
            }
        }

        // Update workout week display
        function updateWorkoutWeekDisplay() {
            const display = document.getElementById('workoutWeekDisplay');
            const selector = document.getElementById('workoutWeekSelector');
            if (display) {
                display.textContent = formatWeekDisplay(currentWorkoutWeek);
            }
            if (selector) {
                selector.value = getWeekValue(currentWorkoutWeek);
            }
        }

        // API Calls
        async function generateWeeklyMeal() {
            const generateBtn = event?.target;
            const originalText = generateBtn?.textContent;

            // Get selected week
            const startDate = getWeekValue(currentMealWeek);

            // Disable button and show loading
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
            }

            try {
                const res = await fetch(`${API_BASE}/api/meal-plan/weekly`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_date: startDate })
                });
                const result = await res.json();

                if (result.success && result.plan) {
                    // Show toast notification
                    if (result.replaced) {
                        const planStartDate = new Date(result.plan.start_date);
                        const planEndDate = new Date(result.plan.end_date);
                        const dateRange = `${planStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${planEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                        showToast(`Existing plan for ${dateRange} replaced.`, 'success');
                    } else {
                        showToast('New weekly plan created!', 'success');
                    }

                    // Reload plans list to show updated single plan
                    await loadMealPlans();

                    // Show the plan on same page
                    if (result.plan.days) {
                        displayWeeklyMealPlan(result.plan, 'mealResult');
                    } else {
                        displayMealPlan(result.plan, 'mealResult');
                    }

                    // Don't auto-adjust week - keep the user's selected week

                    // Auto-update shopping list
                    generateShoppingList();
                } else {
                    showError('mealResult', result.error || 'Failed to generate plan');
                    showToast('Failed to generate plan', 'error');
                }
            } catch (error) {
                showError('mealResult', error.message);
                showToast('Error: ' + error.message, 'error');
            } finally {
                // Re-enable button
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = originalText || 'Generate Weekly Plan';
                }
            }
        }

        async function loadMealPlan(planId, autoAdjustWeek = true) {
            showLoading('mealResult');
            try {
                const res = await fetch(`${API_BASE}/api/meal-plan/${planId}`);
                const result = await res.json();
                if (result.success && result.plan) {
                    // Track the currently displayed plan
                    currentDisplayedMealPlanId = planId;
                    
                    // Only auto-adjust week selector when explicitly requested (from plan list click)
                    if (autoAdjustWeek && result.plan.start_date) {
                        const planStartDate = new Date(result.plan.start_date);
                        planStartDate.setHours(0, 0, 0, 0);
                        
                        // Calculate which week offset this plan belongs to
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        // Calculate the day difference and convert to week offset
                        const daysDiff = Math.round((planStartDate - today) / (24 * 60 * 60 * 1000));
                        const weeksDiff = Math.floor(daysDiff / 7);
                        
                        // Update the week selector
                        currentMealWeek = weeksDiff;
                        updateMealWeekDisplay();
                    }
                    
                    if (result.plan.days) {
                        displayWeeklyMealPlan(result.plan, 'mealResult');
                    } else {
                        displayMealPlan(result.plan, 'mealResult');
                    }
                } else {
                    showError('mealResult', result.error || 'Plan not found');
                }
            } catch (error) {
                showError('mealResult', error.message);
            }
        }

        // Workout Display Functions
        function displayWorkoutPlan(plan, elementId) {
            const container = document.getElementById(elementId);
            let html = '';

            if (plan.workouts && plan.workouts.length > 0) {
                plan.workouts.forEach((workout, index) => {
                    const workoutId = `workout-${index}`;
                    html += `
                        <div class="workout-card" data-workout-id="${workoutId}">
                            <div class="workout-header">
                                <div class="workout-name">${workout.name}</div>
                                <div class="workout-badge">${workout.type || 'Workout'}</div>
                            </div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: var(--spacing-md);">
                                ${workout.description || ''}
                            </div>
                            ${workout.exercises && workout.exercises.length > 0 ? workout.exercises.map(ex => `
                                <div class="exercise-item">
                                    <div class="exercise-name">${ex.name}</div>
                                    <div class="exercise-details">
                                        ${ex.sets ? `${ex.sets} sets √ó ${ex.reps || ''} reps` : ''}
                                        ${ex.duration_seconds ? ` ‚Ä¢ ${Math.floor(ex.duration_seconds / 60)} min` : ''}
                                        ${ex.rest_seconds ? ` ‚Ä¢ Rest: ${ex.rest_seconds}s` : ''}
                                    </div>
                                </div>
                            `).join('') : ''}
                            <div class="meal-actions">
                                <button class="btn-accept" onclick="acceptWorkout('${workoutId}')">Completed</button>
                                <button class="btn-reject" onclick="rejectWorkout('${workoutId}')">Skipped</button>
                            </div>
                        </div>
                    `;
                });
            } else if (plan.is_rest_day) {
                html += '<div class="rest-day">Rest Day - No workouts scheduled</div>';
            }

            container.innerHTML = html;
        }

        function displayWeeklyWorkoutPlan(plan, elementId) {
            const container = document.getElementById(elementId);
            
            // Day colors - different gradient for each day
            const dayColors = [
                'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)', // Monday - Red
                'linear-gradient(135deg, #f97316 0%, #ea580c 100%)', // Tuesday - Orange
                'linear-gradient(135deg, #eab308 0%, #ca8a04 100%)', // Wednesday - Yellow
                'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)', // Thursday - Green
                'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)', // Friday - Blue
                'linear-gradient(135deg, #06b6d4 0%, #0891b2 100%)', // Saturday - Cyan
                'linear-gradient(135deg, #ec4899 0%, #db2777 100%)'  // Sunday - Pink
            ];
            
            let html = '';

            if (plan.days && plan.days.length > 0) {
                plan.days.forEach((day, dayIndex) => {
                    const dayOfWeek = new Date(day.date).getDay();
                    const colorIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                    const dayColor = dayColors[colorIndex];
                    
                    html += `
                        <div class="day-card">
                            <div class="day-header" style="background: ${dayColor};">${new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}</div>
                            <div id="workout-display-${plan.id}-${dayIndex}">
                                ${day.is_rest_day ? '<div style="text-align: center; color: var(--text-secondary); padding: var(--spacing-md);">Rest Day</div>' : ''}
                                ${day.workouts && day.workouts.length > 0 ? day.workouts.map((workout, workoutIndex) => `
                                    <div class="meal-summary" style="position: relative;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div style="flex: 1;">
                                                <span class="meal-summary-name">${workout.name}</span>
                                                <span class="meal-summary-calories">${workout.duration_minutes || 0} min</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('') : ''}
                                <div style="padding: var(--spacing-sm); display: flex; gap: var(--spacing-sm);">
                                    <button class="btn" style="flex: 1; font-size: 0.875rem;" onclick="showDayWorkoutDetails('${plan.id}', ${dayIndex}, ${day.is_rest_day})">View</button>
                                    <button class="btn" style="flex: 1; font-size: 0.875rem; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);" onclick="showWorkoutEditForm('${plan.id}', '${day.date}', ${dayIndex}, ${day.is_rest_day})">Edit</button>
                                </div>
                            </div>
                            <div id="workout-edit-${plan.id}-${dayIndex}" style="display: none;">
                                <form onsubmit="saveWorkoutEdit(event, '${plan.id}', '${day.date}', ${dayIndex}); return false;">
                                    <div class="form-group">
                                        <label class="form-label">
                                            <input type="checkbox" id="edit-workout-rest-${plan.id}-${dayIndex}" ${day.is_rest_day ? 'checked' : ''} onchange="toggleWorkoutRestDay('${plan.id}', ${dayIndex})">
                                            Rest Day
                                        </label>
                                    </div>
                                    <div id="workout-fields-${plan.id}-${dayIndex}" style="${day.is_rest_day ? 'display: none;' : ''}">
                                        <div class="form-group">
                                            <label class="form-label">Workout Name *</label>
                                            <input type="text" id="edit-workout-name-${plan.id}-${dayIndex}" class="form-input" value="${day.workouts && day.workouts[0] ? day.workouts[0].name : ''}" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Duration (minutes) *</label>
                                            <input type="number" id="edit-workout-duration-${plan.id}-${dayIndex}" class="form-input" value="${day.workouts && day.workouts[0] ? day.workouts[0].duration_minutes : 30}" required min="1">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Workout Type *</label>
                                            <input type="text" id="edit-workout-type-${plan.id}-${dayIndex}" class="form-input" value="${day.workouts && day.workouts[0] ? day.workouts[0].type : 'general'}" required>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: var(--spacing-sm);">
                                        <button type="submit" class="btn" style="flex: 1;">Save</button>
                                        <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="cancelWorkoutEdit('${plan.id}', ${dayIndex})">Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        // Shopping List Display
        function displayShoppingList(shoppingList, elementId) {
            displayShoppingListWithManual(shoppingList, elementId);
        }

        function displayShoppingListByWeek(shoppingListsByWeek, elementId) {
            const container = document.getElementById(elementId);
            let html = '';
            const currentWeekStart = getCurrentWeekStart();

            // Sort weeks by start date and filter to current week and future only
            const sortedWeeks = Object.entries(shoppingListsByWeek)
                .filter(([weekStart, weekData]) => {
                    // Only include weeks that start on or after current week
                    return weekData.week_start >= currentWeekStart;
                })
                .sort((a, b) => a[0].localeCompare(b[0]));

            sortedWeeks.forEach(([weekStart, weekData]) => {
                const startDate = new Date(weekData.week_start);
                const endDate = new Date(weekData.week_end);
                const weekLabel = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;

                html += `
                    <div class="card" style="margin-bottom: var(--spacing-lg);">
                        <div class="card-header" style="margin-bottom: var(--spacing-md);">
                            <h3 style="font-size: 1.125rem; font-weight: 600;">Week: ${weekLabel}</h3>
                            <small style="color: var(--text-secondary);">${weekData.total_items} items</small>
                        </div>
                `;

                // Merge with manual items
                const allByCategory = {};
                if (weekData.by_category) {
                    Object.entries(weekData.by_category).forEach(([category, items]) => {
                        if (!allByCategory[category]) {
                            allByCategory[category] = [];
                        }
                        allByCategory[category].push(...items);
                    });
                }

                // Add manual items (only current week and future)
                getCurrentWeekItems().forEach(item => {
                    const cat = item.category || 'other';
                    if (!allByCategory[cat]) {
                        allByCategory[cat] = [];
                    }
                    allByCategory[cat].push(item);
                });

                if (Object.keys(allByCategory).length > 0) {
                    Object.entries(allByCategory).forEach(([category, items]) => {
                        html += `
                            <div class="shopping-category" style="margin-bottom: var(--spacing-md);">
                                <div class="category-header">${category}</div>
                                ${items.map((item, index) => {
                            const itemId = `item-${weekStart}-${category}-${index}-${item.id || index}`;
                            return `
                                        <div class="shopping-item" data-item-id="${itemId}" data-state="none">
                                            <div class="shopping-item-name">${item.name}</div>
                                            <div class="shopping-item-quantity">${item.quantity} ${item.unit || ''}</div>
                                            <div class="shopping-actions">
                                                <button class="btn-accept" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="acceptItem('${itemId}')">‚úì</button>
                                                ${item.is_manual ? `<button class="btn-reject" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="deleteShoppingItem('${item.id}')">‚úï</button>` : `<button class="btn-reject" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="rejectItem('${itemId}')">‚úï</button>`}
                                            </div>
                                        </div>
                                    `;
                        }).join('')}
                            </div>
                        `;
                    });
                } else {
                    html += '<div style="text-align: center; padding: var(--spacing-md); color: var(--text-secondary);">No items for this week</div>';
                }

                html += '</div>';
            });

            if (sortedWeeks.length === 0) {
                // No current week data from API, show manual items only
                displayCurrentWeekShoppingList(elementId);
                return;
            }

            container.innerHTML = html;
        }

        // Workout API Calls
        async function generateWeeklyWorkout() {
            const generateBtn = event?.target;
            const originalText = generateBtn?.textContent;

            // Get selected week
            const startDate = getWeekValue(currentWorkoutWeek);

            // Disable button and show loading
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
            }

            showLoading('workoutResult');
            try {
                const res = await fetch(`${API_BASE}/api/workout-plan/weekly`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start_date: startDate })
                });
                const result = await res.json();
                if (result.success && result.plan) {
                    // Show toast notification
                    if (result.replaced) {
                        const planStartDate = new Date(result.plan.start_date);
                        const planEndDate = new Date(result.plan.end_date);
                        const dateRange = `${planStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${planEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                        showToast(`Existing workout plan for ${dateRange} replaced.`, 'success');
                    } else {
                        showToast('New weekly workout plan created!', 'success');
                    }

                    if (result.plan.days) {
                        displayWeeklyWorkoutPlan(result.plan, 'workoutResult');
                    } else {
                        displayWorkoutPlan(result.plan, 'workoutResult');
                    }
                    loadWorkoutPlans();

                    // Update week display to match the generated plan
                    const planStartDate = new Date(result.plan.start_date);
                    const today = new Date();
                    const daysDiff = Math.floor((planStartDate - today) / (1000 * 60 * 60 * 24));
                    const weekDiff = Math.floor(daysDiff / 7);
                    currentWorkoutWeek = weekDiff;
                    updateWorkoutWeekDisplay();

                    // Auto-update shopping list (in case meal plans changed)
                    generateShoppingList();
                } else {
                    showError('workoutResult', result.error || 'Failed to generate plan');
                    showToast('Failed to generate plan', 'error');
                }
            } catch (error) {
                showError('workoutResult', error.message);
                showToast('Error: ' + error.message, 'error');
            } finally {
                // Re-enable button
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = originalText || 'Generate Weekly Plan';
                }
            }
        }

        async function loadWorkoutPlan(planId, autoAdjustWeek = true) {
            showLoading('workoutResult');
            try {
                const res = await fetch(`${API_BASE}/api/workout-plan/${planId}`);
                const result = await res.json();
                if (result.success && result.plan) {
                    // Auto-adjust week selector when clicking from plan list
                    if (autoAdjustWeek && result.plan.start_date) {
                        const planStartDate = new Date(result.plan.start_date);
                        planStartDate.setHours(0, 0, 0, 0);
                        
                        // Calculate which week offset this plan belongs to
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        
                        // Calculate the day difference and convert to week offset
                        const daysDiff = Math.round((planStartDate - today) / (24 * 60 * 60 * 1000));
                        const weeksDiff = Math.floor(daysDiff / 7);
                        
                        // Update the week selector
                        currentWorkoutWeek = weeksDiff;
                        updateWorkoutWeekDisplay();
                    }
                    
                    if (result.plan.days) {
                        displayWeeklyWorkoutPlan(result.plan, 'workoutResult');
                    } else {
                        displayWorkoutPlan(result.plan, 'workoutResult');
                    }
                } else {
                    showError('workoutResult', result.error || 'Plan not found');
                }
            } catch (error) {
                showError('workoutResult', error.message);
            }
        }

        // Shopping List API Call - shows only current week items
        async function generateShoppingList() {
            showLoading('shoppingResult');
            const currentWeekItems = getCurrentWeekItems();
            
            try {
                const res = await fetch(`${API_BASE}/api/shopping-list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await res.json();
                if (result.success) {
                    if (result.shopping_lists_by_week) {
                        // Multiple weeks - show weekly cards (filtered to current week)
                        displayShoppingListByWeek(result.shopping_lists_by_week, 'shoppingResult');
                    } else if (result.shopping_list) {
                        // Single plan - show regular list
                        displayShoppingList(result.shopping_list, 'shoppingResult');
                    } else {
                        // No API data - show only current week manual items
                        displayCurrentWeekShoppingList('shoppingResult');
                    }
                } else {
                    // Show current week manual items even if generation fails
                    displayCurrentWeekShoppingList('shoppingResult');
                }
            } catch (error) {
                // Show current week manual items even if API fails
                displayCurrentWeekShoppingList('shoppingResult');
            }
        }
        
        // Display only current week's shopping items
        function displayCurrentWeekShoppingList(elementId) {
            const container = document.getElementById(elementId);
            const currentWeekItems = getCurrentWeekItems();
            
            if (currentWeekItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">No items for this week. Add items above or generate from meal plans.</div>';
                return;
            }
            
            const byCategory = groupItemsByCategory(currentWeekItems);
            let html = '';
            
            Object.entries(byCategory).forEach(([category, items]) => {
                html += `
                    <div class="shopping-category">
                        <div class="category-header">${category}</div>
                        ${items.map((item, index) => {
                            const itemId = `item-${category}-${index}-${item.id || index}`;
                            return `
                                <div class="shopping-item" data-item-id="${itemId}" data-state="none">
                                    <div class="shopping-item-name">${item.name}</div>
                                    <div class="shopping-item-quantity">${item.quantity} ${item.unit || ''}</div>
                                    <div class="shopping-actions">
                                        <button class="btn-accept" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="acceptItem('${itemId}')">‚úì</button>
                                        <button class="btn-reject" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="deleteShoppingItem('${item.id}')">‚úï</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Delete a shopping item
        function deleteShoppingItem(itemId) {
            manualShoppingItems = manualShoppingItems.filter(item => item.id !== itemId);
            localStorage.setItem('manualShoppingItems', JSON.stringify(manualShoppingItems));
            generateShoppingList();
            showToast('Item removed', 'success');
        }

        // Initialize on page load
        function initializeApp() {
            // Initialize week displays
            updateMealWeekDisplay();
            updateWorkoutWeekDisplay();

            // Initialize category list
            updateCategoryList();

            // Load plans for current week
            loadMealPlansForWeek();
            loadWorkoutPlansForWeek();

            // Auto-generate shopping list on load
            generateShoppingList();
        }

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Fix button focus state - blur buttons after click to remove focus styling
        document.addEventListener('mouseup', function(e) {
            const btn = e.target.closest('button, .btn, .btn-quick, .nav-item');
            if (btn) {
                // Immediate blur to reset button state
                btn.blur();
                // Also remove any lingering focus after a short delay
                setTimeout(() => {
                    if (document.activeElement === btn) {
                        btn.blur();
                    }
                }, 50);
            }
        });
        
        // Also handle touchend for mobile devices
        document.addEventListener('touchend', function(e) {
            const btn = e.target.closest('button, .btn, .btn-quick, .nav-item');
            if (btn) {
                setTimeout(() => {
                    btn.blur();
                }, 50);
            }
        });

        // Accept/Reject for Workouts and Shopping
        function acceptWorkout(workoutId) {
            const card = document.querySelector(`[data-workout-id="${workoutId}"]`);
            const actions = card.querySelector('.meal-actions');
            actions.innerHTML = '<span class="status-badge status-accepted">Completed</span>';
            card.style.borderLeft = '4px solid var(--success)';
        }

        function rejectWorkout(workoutId) {
            const card = document.querySelector(`[data-workout-id="${workoutId}"]`);
            const actions = card.querySelector('.meal-actions');
            actions.innerHTML = '<span class="status-badge status-rejected">Skipped</span>';
            card.style.borderLeft = '4px solid var(--error)';
        }

        function acceptItem(itemId) {
            const item = document.querySelector(`[data-item-id="${itemId}"]`);
            if (item) {
                const actions = item.querySelector('.shopping-actions');
                if (actions) {
                    const currentState = item.dataset.state || 'none';
                    if (currentState === 'accepted') {
                        // Toggle off - undo
                        item.style.opacity = '1';
                        item.style.textDecoration = 'none';
                        item.dataset.state = 'none';
                        actions.innerHTML = `
                            <button class="btn-accept" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="acceptItem('${itemId}')">‚úì</button>
                            <button class="btn-reject" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="rejectItem('${itemId}')">‚úï</button>
                        `;
                    } else {
                        // Toggle on
                        item.style.opacity = '0.6';
                        item.style.textDecoration = 'line-through';
                        item.dataset.state = 'accepted';
                        actions.innerHTML = `
                            <button class="btn-accept" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem; background: var(--success);" onclick="acceptItem('${itemId}')">‚úì</button>
                            <button class="btn-reject" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="rejectItem('${itemId}')">‚úï</button>
                        `;
                    }
                }
            }
        }

        function rejectItem(itemId) {
            const item = document.querySelector(`[data-item-id="${itemId}"]`);
            if (item) {
                const actions = item.querySelector('.shopping-actions');
                if (actions) {
                    const currentState = item.dataset.state || 'none';
                    if (currentState === 'rejected') {
                        // Toggle off - undo
                        item.style.opacity = '1';
                        item.style.textDecoration = 'none';
                        item.dataset.state = 'none';
                        actions.innerHTML = `
                            <button class="btn-accept" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="acceptItem('${itemId}')">‚úì</button>
                            <button class="btn-reject" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="rejectItem('${itemId}')">‚úï</button>
                        `;
                    } else {
                        // Toggle on
                        item.style.opacity = '0.5';
                        item.dataset.state = 'rejected';
                        actions.innerHTML = `
                            <button class="btn-accept" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="acceptItem('${itemId}')">‚úì</button>
                            <button class="btn-reject" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem; background: var(--error);" onclick="rejectItem('${itemId}')">‚úï</button>
                        `;
                    }
                }
            }
        }

        // Modal Functions
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function showModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modalOverlay').classList.add('active');
        }

        async function showMealInstructions(planId, date, mealType, dayIndex, mealIndex) {
            console.log('showMealInstructions called:', { planId, date, mealType, dayIndex, mealIndex });
            showToast('Loading meal details...', 'info');
            try {
                const res = await fetch(`${API_BASE}/api/meal-plan/${planId}`);
                if (!res.ok) {
                    showToast('Failed to load meal plan', 'error');
                    return;
                }
                const result = await res.json();
                console.log('API response:', result);
                
                if (!result.success || !result.plan) {
                    console.error('No plan in response:', result);
                    showToast('Error loading plan', 'error');
                    return;
                }

                if (!result.plan.days || !result.plan.days[dayIndex]) {
                    console.error('Day not found:', { days: result.plan.days, dayIndex });
                    showToast('Day not found in plan', 'error');
                    return;
                }

                const day = result.plan.days[dayIndex];
                console.log('Day data:', day);
                
                const meal = day.meals.find(m => m.type === mealType);
                console.log('Found meal:', meal);

                if (!meal) {
                    console.error('Meal not found:', { meals: day.meals, mealType });
                    showToast('Meal not found', 'error');
                    return;
                }

                const mealEmojis = {
                    breakfast: 'üç≥',
                    lunch: 'üç±',
                    dinner: 'üçΩÔ∏è',
                    snack: 'üçé'
                };
                const emoji = mealEmojis[mealType] || 'üç¥';

                let content = `
                    <div style="margin-bottom: var(--spacing-lg);">
                        <div style="display: flex; align-items: center; gap: var(--spacing-sm); margin-bottom: var(--spacing-sm);">
                            <span style="font-size: 2rem;">${emoji}</span>
                            <h4 style="font-size: 1.25rem; font-weight: 700;">${meal.name || 'Meal'}</h4>
                        </div>
                        ${meal.description ? `<p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">${meal.description}</p>` : ''}
                        <div style="display: flex; gap: var(--spacing-lg); flex-wrap: wrap; margin-top: var(--spacing-md);">
                            <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius); font-weight: 600;">
                                üî• ${meal.calories || 0} kcal
                            </div>
                            <div style="background: var(--bg); padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius); font-size: 0.875rem;">
                                üí™ ${safeToFixed(meal.protein)}g protein
                            </div>
                            <div style="background: var(--bg); padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius); font-size: 0.875rem;">
                                üçû ${safeToFixed(meal.carbs)}g carbs
                            </div>
                            <div style="background: var(--bg); padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius); font-size: 0.875rem;">
                                ü•ë ${safeToFixed(meal.fat)}g fat
                            </div>
                        </div>
                    </div>
                `;

                if (meal.ingredients && meal.ingredients.length > 0) {
                    content += `
                        <div style="margin-bottom: var(--spacing-lg); background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid #86efac;">
                            <h5 style="font-weight: 700; margin-bottom: var(--spacing-md); color: #166534; display: flex; align-items: center; gap: var(--spacing-sm);">
                                ü•¨ Ingredients
                            </h5>
                            <ul style="list-style: none; padding: 0; margin: 0;">
                                ${meal.ingredients.map(ing => `
                                    <li style="padding: var(--spacing-sm) 0; border-bottom: 1px solid rgba(134, 239, 172, 0.3); display: flex; align-items: center; gap: var(--spacing-sm);">
                                        <span style="color: #16a34a;">‚úì</span> ${ing}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    content += `
                        <div style="margin-bottom: var(--spacing-lg); background: var(--bg); padding: var(--spacing-lg); border-radius: var(--radius-lg); color: var(--text-secondary);">
                            <h5 style="font-weight: 600; margin-bottom: var(--spacing-sm);">ü•¨ Ingredients</h5>
                            <p style="font-style: italic;">No ingredients listed for this meal.</p>
                        </div>
                    `;
                }

                if (meal.instructions && meal.instructions.length > 0) {
                    content += `
                        <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid #93c5fd;">
                            <h5 style="font-weight: 700; margin-bottom: var(--spacing-md); color: #1e40af; display: flex; align-items: center; gap: var(--spacing-sm);">
                                üìù Cooking Instructions
                            </h5>
                            <ol style="padding-left: var(--spacing-xl); margin: 0;">
                                ${meal.instructions.map((inst, idx) => `
                                    <li style="padding: var(--spacing-sm) 0; line-height: 1.6; color: var(--text-primary);">
                                        ${inst}
                                    </li>
                                `).join('')}
                            </ol>
                        </div>
                    `;
                } else {
                    content += `
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid #fbbf24;">
                            <h5 style="font-weight: 600; margin-bottom: var(--spacing-sm); color: #92400e;">üìù Cooking Instructions</h5>
                            <p style="color: #92400e;">No detailed instructions available for this meal. This is a simple recipe - prepare ingredients as needed!</p>
                        </div>
                    `;
                }

                hideToast();
                showModal(`${emoji} ${meal.name || 'Meal'}`, content);
            } catch (error) {
                hideToast();
                showToast('Error: ' + error.message, 'error');
            }
        }

        async function showDayWorkoutDetails(planId, dayIndex, isRestDay) {
            if (isRestDay) {
                showModal('Rest Day', `
                    <div style="text-align: center; padding: var(--spacing-xl);">
                        <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üò¥</div>
                        <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: var(--spacing-sm);">Rest Day</h3>
                        <p style="color: var(--text-secondary);">Take it easy today! Rest is essential for muscle recovery and growth.</p>
                    </div>
                `);
                return;
            }

            try {
                const res = await fetch(`${API_BASE}/api/workout-plan/${planId}`);
                const result = await res.json();
                if (!result.success || !result.plan) {
                    showToast('Error loading plan', 'error');
                    return;
                }

                const day = result.plan.days[dayIndex];
                const dateStr = new Date(day.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                let content = `
                    <div style="margin-bottom: var(--spacing-lg);">
                        <h4 style="font-size: 1.125rem; font-weight: 600; margin-bottom: var(--spacing-sm);">üìÖ ${dateStr}</h4>
                    </div>
                `;

                if (day.workouts && day.workouts.length > 0) {
                    day.workouts.forEach((workout, idx) => {
                        content += `
                            <div style="background: var(--bg); border-radius: var(--radius); padding: var(--spacing-lg); margin-bottom: var(--spacing-md);">
                                <h5 style="font-size: 1rem; font-weight: 600; margin-bottom: var(--spacing-sm);">${workout.name}</h5>
                                <div style="display: flex; gap: var(--spacing-md); color: var(--text-secondary); font-size: 0.875rem; margin-bottom: var(--spacing-md); flex-wrap: wrap;">
                                    <span>üèãÔ∏è ${workout.type || 'General'}</span>
                                    <span>‚è±Ô∏è ${workout.duration_minutes || 0} min</span>
                                    ${workout.difficulty ? `<span>üìä ${workout.difficulty}</span>` : ''}
                                </div>
                                ${workout.description ? `<p style="color: var(--text-secondary); margin-bottom: var(--spacing-md);">${workout.description}</p>` : ''}
                        `;

                        if (workout.exercises && workout.exercises.length > 0) {
                            content += `
                                <div style="margin-top: var(--spacing-md);">
                                    <h6 style="font-weight: 600; margin-bottom: var(--spacing-sm); font-size: 0.875rem;">Exercises:</h6>
                                    ${workout.exercises.map((ex, exIdx) => `
                                        <div style="padding: var(--spacing-sm) 0; border-bottom: 1px solid var(--border);">
                                            <div style="font-weight: 500;">${exIdx + 1}. ${ex.name}</div>
                                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px;">
                                                ${ex.sets ? `${ex.sets} sets` : ''}
                                                ${ex.reps ? ` √ó ${ex.reps} reps` : ''}
                                                ${ex.duration_seconds ? ` ‚Ä¢ ${Math.floor(ex.duration_seconds / 60)} min` : ''}
                                                ${ex.rest_seconds ? ` ‚Ä¢ Rest: ${ex.rest_seconds}s` : ''}
                                            </div>
                                            ${ex.description ? `<div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 4px;">${ex.description}</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }

                        content += `</div>`;
                    });
                } else {
                    content += `
                        <div style="text-align: center; color: var(--text-secondary); padding: var(--spacing-xl);">
                            <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">üèÉ</div>
                            <p>No workouts scheduled for this day.</p>
                        </div>
                    `;
                }

                showModal('Day Workout Plan', content);
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Edit Functions
        function showMealEditForm(planId, date, mealType, dayIndex, mealIndex) {
            document.getElementById(`meal-display-${planId}-${dayIndex}-${mealIndex}`).style.display = 'none';
            document.getElementById(`meal-edit-${planId}-${dayIndex}-${mealIndex}`).style.display = 'block';
        }

        function cancelMealEdit(planId, dayIndex, mealIndex) {
            document.getElementById(`meal-display-${planId}-${dayIndex}-${mealIndex}`).style.display = 'block';
            document.getElementById(`meal-edit-${planId}-${dayIndex}-${mealIndex}`).style.display = 'none';
        }

        async function saveMealEdit(event, planId, date, mealType, dayIndex, mealIndex) {
            event.preventDefault();

            const name = document.getElementById(`edit-meal-name-${planId}-${dayIndex}-${mealIndex}`).value.trim();
            const calories = parseInt(document.getElementById(`edit-meal-calories-${planId}-${dayIndex}-${mealIndex}`).value) || 0;
            const protein = parseFloat(document.getElementById(`edit-meal-protein-${planId}-${dayIndex}-${mealIndex}`).value) || 0;
            const carbs = parseFloat(document.getElementById(`edit-meal-carbs-${planId}-${dayIndex}-${mealIndex}`).value) || 0;
            const fat = parseFloat(document.getElementById(`edit-meal-fat-${planId}-${dayIndex}-${mealIndex}`).value) || 0;

            if (!name) {
                showToast('Meal name is required', 'error');
                return;
            }

            const mealData = {
                id: `meal_${date}_${mealType}`,
                name: name,
                description: '',
                calories: calories,
                protein: protein,
                carbs: carbs,
                fat: fat,
                ingredients: [],
                instructions: [],
                prep_time: 0,
                cook_time: 0
            };

            try {
                const res = await fetch(`${API_BASE}/api/meal-plan/${planId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: date,
                        meal_type: mealType,
                        meal: mealData
                    })
                });
                const result = await res.json();
                if (result.success) {
                    showToast('Meal updated!', 'success');
                    loadMealPlan(planId, false); // Don't auto-adjust week when editing
                    // Auto-update shopping list
                    generateShoppingList();
                } else {
                    showToast('Error: ' + (result.error || 'Failed to update'), 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        function showWorkoutEditForm(planId, date, dayIndex, isRestDay) {
            document.getElementById(`workout-display-${planId}-${dayIndex}`).style.display = 'none';
            document.getElementById(`workout-edit-${planId}-${dayIndex}`).style.display = 'block';
        }

        function cancelWorkoutEdit(planId, dayIndex) {
            document.getElementById(`workout-display-${planId}-${dayIndex}`).style.display = 'block';
            document.getElementById(`workout-edit-${planId}-${dayIndex}`).style.display = 'none';
        }

        function toggleWorkoutRestDay(planId, dayIndex) {
            const isRestDay = document.getElementById(`edit-workout-rest-${planId}-${dayIndex}`).checked;
            const fields = document.getElementById(`workout-fields-${planId}-${dayIndex}`);
            fields.style.display = isRestDay ? 'none' : 'block';

            if (!isRestDay) {
                document.getElementById(`edit-workout-name-${planId}-${dayIndex}`).required = true;
                document.getElementById(`edit-workout-duration-${planId}-${dayIndex}`).required = true;
                document.getElementById(`edit-workout-type-${planId}-${dayIndex}`).required = true;
            } else {
                document.getElementById(`edit-workout-name-${planId}-${dayIndex}`).required = false;
                document.getElementById(`edit-workout-duration-${planId}-${dayIndex}`).required = false;
                document.getElementById(`edit-workout-type-${planId}-${dayIndex}`).required = false;
            }
        }

        async function saveWorkoutEdit(event, planId, date, dayIndex) {
            event.preventDefault();

            const isRestDay = document.getElementById(`edit-workout-rest-${planId}-${dayIndex}`).checked;

            if (isRestDay) {
                // Set as rest day
                try {
                    const res = await fetch(`${API_BASE}/api/workout-plan/${planId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            date: date,
                            workout: null
                        })
                    });
                    const result = await res.json();
                    if (result.success) {
                        showToast('Workout updated!', 'success');
                        // Auto-update shopping list (in case meal plans changed)
                        generateShoppingList();
                        loadWorkoutPlan(planId);
                        // Auto-update shopping list (in case meal plans changed)
                        generateShoppingList();
                    } else {
                        showToast('Error: ' + (result.error || 'Failed to update'), 'error');
                    }
                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                }
            } else {
                // Add/edit workout
                const workoutName = document.getElementById(`edit-workout-name-${planId}-${dayIndex}`).value.trim();
                const duration = parseInt(document.getElementById(`edit-workout-duration-${planId}-${dayIndex}`).value) || 30;
                const workoutType = document.getElementById(`edit-workout-type-${planId}-${dayIndex}`).value.trim();

                if (!workoutName || !workoutType) {
                    showToast('Workout name and type are required', 'error');
                    return;
                }

                const workoutData = {
                    id: `workout_${date}`,
                    name: workoutName,
                    type: workoutType,
                    difficulty: 'intermediate',
                    description: '',
                    duration_minutes: duration,
                    exercises: []
                };

                try {
                    const res = await fetch(`${API_BASE}/api/workout-plan/${planId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            date: date,
                            workout: workoutData
                        })
                    });
                    const result = await res.json();
                    if (result.success) {
                        showToast('Workout updated!', 'success');
                        // Auto-update shopping list (in case meal plans changed)
                        generateShoppingList();
                        loadWorkoutPlan(planId);
                        // Auto-update shopping list (in case meal plans changed)
                        generateShoppingList();
                    } else {
                        showToast('Error: ' + (result.error || 'Failed to update'), 'error');
                    }
                } catch (error) {
                    showToast('Error: ' + error.message, 'error');
                }
            }
        }

        // Store manually added items
        let manualShoppingItems = JSON.parse(localStorage.getItem('manualShoppingItems') || '[]');
        let shoppingCategories = JSON.parse(localStorage.getItem('shoppingCategories') || '[]');

        // Get current week start date (Monday)
        function getCurrentWeekStart() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const dayOfWeek = today.getDay();
            const daysToMonday = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
            const monday = new Date(today);
            monday.setDate(today.getDate() + daysToMonday);
            return monday.toISOString().split('T')[0];
        }

        // Filter items for current week and future
        function getCurrentWeekItems() {
            const currentWeekStart = getCurrentWeekStart();
            return manualShoppingItems.filter(item => {
                const itemWeek = item.weekStart || '2000-01-01';
                return itemWeek >= currentWeekStart;
            });
        }

        // Filter items for past weeks (history)
        function getHistoryItems() {
            const currentWeekStart = getCurrentWeekStart();
            return manualShoppingItems.filter(item => {
                const itemWeek = item.weekStart || '2000-01-01';
                return itemWeek < currentWeekStart;
            });
        }

        function updateCategoryList() {
            const categoryList = document.getElementById('categoryList');
            if (categoryList) {
                categoryList.innerHTML = shoppingCategories.map(cat => `<option value="${cat}">`).join('');
            }
        }

        function saveManualShopping(event) {
            event.preventDefault();

            const category = document.getElementById('shoppingCategory').value.trim();
            const itemName = document.getElementById('shoppingItemName').value.trim();
            const quantity = parseFloat(document.getElementById('shoppingQuantity').value);
            const unit = document.getElementById('shoppingUnit').value.trim();

            if (!category || !itemName || !quantity || !unit) {
                showToast('All fields are required', 'error');
                return;
            }

            // Add category if new
            if (!shoppingCategories.includes(category)) {
                shoppingCategories.push(category);
                localStorage.setItem('shoppingCategories', JSON.stringify(shoppingCategories));
                updateCategoryList();
            }

            // Add item with current week start
            const item = {
                id: `manual_${Date.now()}`,
                name: itemName,
                quantity: quantity,
                unit: unit,
                category: category,
                is_optional: false,
                is_manual: true,
                weekStart: getCurrentWeekStart(),
                addedAt: new Date().toISOString()
            };

            manualShoppingItems.push(item);
            localStorage.setItem('manualShoppingItems', JSON.stringify(manualShoppingItems));

            // Clear form
            document.getElementById('shoppingEntryForm').reset();
            showToast('Item added!', 'success');

            // Auto-refresh shopping list
            generateShoppingList();
        }

        function groupItemsByCategory(items) {
            const grouped = {};
            items.forEach(item => {
                const cat = item.category || 'other';
                if (!grouped[cat]) {
                    grouped[cat] = [];
                }
                grouped[cat].push(item);
            });
            return grouped;
        }

        function displayShoppingListWithManual(shoppingList, elementId) {
            const container = document.getElementById(elementId);
            let html = '';

            // Merge generated and manual items by category
            const allByCategory = {};

            // Add generated items
            if (shoppingList.by_category) {
                Object.entries(shoppingList.by_category).forEach(([category, items]) => {
                    if (!allByCategory[category]) {
                        allByCategory[category] = [];
                    }
                    allByCategory[category].push(...items);
                });
            } else if (shoppingList.items) {
                shoppingList.items.forEach(item => {
                    const cat = item.category || 'other';
                    if (!allByCategory[cat]) {
                        allByCategory[cat] = [];
                    }
                    allByCategory[cat].push(item);
                });
            }

            // Add manual items (only current week and future)
            getCurrentWeekItems().forEach(item => {
                const cat = item.category || 'other';
                if (!allByCategory[cat]) {
                    allByCategory[cat] = [];
                }
                allByCategory[cat].push(item);
            });

            if (Object.keys(allByCategory).length > 0) {
                Object.entries(allByCategory).forEach(([category, items]) => {
                    html += `
                        <div class="shopping-category">
                            <div class="category-header">${category}</div>
                            ${items.map((item, index) => {
                        const itemId = `item-${category}-${index}-${item.id || index}`;
                        return `
                                    <div class="shopping-item" data-item-id="${itemId}" data-state="none">
                                        <div class="shopping-item-name">${item.name}</div>
                                        <div class="shopping-item-quantity">${item.quantity} ${item.unit || ''}</div>
                                        <div class="shopping-actions">
                                            <button class="btn-accept" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="acceptItem('${itemId}')">‚úì</button>
                                            ${item.is_manual ? `<button class="btn-reject" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="deleteShoppingItem('${item.id}')">‚úï</button>` : `<button class="btn-reject" style="padding: var(--spacing-xs) var(--spacing-md); font-size: 0.75rem;" onclick="rejectItem('${itemId}')">‚úï</button>`}
                                        </div>
                                    </div>
                                `;
                    }).join('')}
                        </div>
                    `;
                });
            } else {
                html = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">No items for this week. Add items above or generate from meal plans.</div>';
            }

            container.innerHTML = html;
        }

        // Load shopping history (past weeks) - combines API data and manual items
        async function loadShoppingHistory() {
            const container = document.getElementById('shoppingHistory');
            container.innerHTML = '<div class="loading">Loading history...</div>';
            
            const currentWeekStart = getCurrentWeekStart();
            const historyManualItems = getHistoryItems();
            
            try {
                // Fetch all shopping lists from API
                const res = await fetch(`${API_BASE}/api/shopping-list`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await res.json();
                
                // Combine API data with manual history items
                const allWeeksData = {};
                
                // Add API data (past weeks only)
                if (result.success && result.shopping_lists_by_week) {
                    Object.entries(result.shopping_lists_by_week).forEach(([weekStart, weekData]) => {
                        // Only include past weeks
                        if (weekStart < currentWeekStart) {
                            allWeeksData[weekStart] = {
                                week_start: weekData.week_start,
                                week_end: weekData.week_end,
                                by_category: weekData.by_category || {}
                            };
                        }
                    });
                }
                
                // Add manual history items
                historyManualItems.forEach(item => {
                    const weekStart = item.weekStart || '2000-01-01';
                    if (!allWeeksData[weekStart]) {
                        const weekDate = new Date(weekStart + 'T00:00:00');
                        const weekEnd = new Date(weekDate);
                        weekEnd.setDate(weekEnd.getDate() + 6);
                        allWeeksData[weekStart] = {
                            week_start: weekStart,
                            week_end: weekEnd.toISOString().split('T')[0],
                            by_category: {}
                        };
                    }
                    const cat = item.category || 'other';
                    if (!allWeeksData[weekStart].by_category[cat]) {
                        allWeeksData[weekStart].by_category[cat] = [];
                    }
                    allWeeksData[weekStart].by_category[cat].push({
                        name: item.name,
                        quantity: item.quantity,
                        unit: item.unit || '',
                        is_manual: true
                    });
                });
                
                // Sort weeks descending (most recent first)
                const sortedWeeks = Object.keys(allWeeksData).sort((a, b) => b.localeCompare(a));
                
                if (sortedWeeks.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">No shopping history yet.</div>';
                    return;
                }
                
                let html = '';
                sortedWeeks.forEach(weekStart => {
                    const weekData = allWeeksData[weekStart];
                    let weekLabel;
                    
                    if (weekStart === 'Unknown' || !weekStart || weekStart === '2000-01-01') {
                        weekLabel = 'Unknown Date';
                    } else {
                        const weekDate = new Date(weekStart + 'T00:00:00');
                        if (isNaN(weekDate.getTime())) {
                            weekLabel = 'Unknown Date';
                        } else {
                            const weekEnd = new Date(weekData.week_end + 'T00:00:00');
                            weekLabel = `${weekDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                        }
                    }
                    
                    const byCategory = weekData.by_category || {};
                    const totalItems = Object.values(byCategory).reduce((sum, items) => sum + items.length, 0);
                    
                    html += `
                        <div class="card" style="margin-bottom: var(--spacing-md);">
                            <div class="card-header" style="margin-bottom: var(--spacing-md);">
                                <h3 style="font-size: 1rem; font-weight: 600;">üìÖ Week: ${weekLabel}</h3>
                                <small style="color: var(--text-secondary);">${totalItems} items</small>
                            </div>
                    `;
                    
                    if (Object.keys(byCategory).length > 0) {
                        Object.entries(byCategory).forEach(([category, items]) => {
                            html += `
                                <div class="shopping-category" style="margin-bottom: var(--spacing-md);">
                                    <div class="category-header">${category}</div>
                                    ${items.map(item => `
                                        <div class="shopping-item" style="opacity: 0.8;">
                                            <div class="shopping-item-name">${item.name}</div>
                                            <div class="shopping-item-quantity">${item.quantity} ${item.unit || ''}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        });
                    } else {
                        html += '<div style="text-align: center; padding: var(--spacing-md); color: var(--text-secondary);">No items for this week</div>';
                    }
                    
                    html += '</div>';
                });
                
                container.innerHTML = html;
            } catch (error) {
                // Fallback to manual items only
                if (historyManualItems.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: var(--spacing-lg); color: var(--text-secondary);">No shopping history yet.</div>';
                    return;
                }
                
                // Group manual items by week
                const byWeek = {};
                historyManualItems.forEach(item => {
                    const week = item.weekStart || 'Unknown';
                    if (!byWeek[week]) {
                        byWeek[week] = [];
                    }
                    byWeek[week].push(item);
                });
                
                const sortedWeeks = Object.keys(byWeek).sort((a, b) => b.localeCompare(a));
                
                let html = '';
                sortedWeeks.forEach(weekStart => {
                    let weekLabel;
                    if (weekStart === 'Unknown' || !weekStart) {
                        weekLabel = 'Unknown Date';
                    } else {
                        const weekDate = new Date(weekStart + 'T00:00:00');
                        if (isNaN(weekDate.getTime())) {
                            weekLabel = 'Unknown Date';
                        } else {
                            const weekEnd = new Date(weekDate);
                            weekEnd.setDate(weekEnd.getDate() + 6);
                            weekLabel = `${weekDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                        }
                    }
                    
                    const byCategory = {};
                    byWeek[weekStart].forEach(item => {
                        const cat = item.category || 'other';
                        if (!byCategory[cat]) {
                            byCategory[cat] = [];
                        }
                        byCategory[cat].push(item);
                    });
                    
                    const totalItems = byWeek[weekStart].length;
                    
                    html += `
                        <div class="card" style="margin-bottom: var(--spacing-md);">
                            <div class="card-header" style="margin-bottom: var(--spacing-md);">
                                <h3 style="font-size: 1rem; font-weight: 600;">üìÖ Week: ${weekLabel}</h3>
                                <small style="color: var(--text-secondary);">${totalItems} items</small>
                            </div>
                    `;
                    
                    Object.entries(byCategory).forEach(([category, items]) => {
                        html += `
                            <div class="shopping-category" style="margin-bottom: var(--spacing-md);">
                                <div class="category-header">${category}</div>
                                ${items.map(item => `
                                    <div class="shopping-item" style="opacity: 0.8;">
                                        <div class="shopping-item-name">${item.name}</div>
                                        <div class="shopping-item-quantity">${item.quantity} ${item.unit || ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                });
                
                container.innerHTML = html;
            }
        }

        // Accept/Reject Functions
        function acceptMeal(mealId, mealType) {
            const card = document.querySelector(`[data-meal-id="${mealId}"]`);
            const actions = card.querySelector('.meal-actions');
            actions.innerHTML = '<span class="status-badge status-accepted">Accepted</span>';
            card.style.borderLeft = '4px solid var(--success)';
        }

        function rejectMeal(mealId, mealType) {
            const card = document.querySelector(`[data-meal-id="${mealId}"]`);
            const actions = card.querySelector('.meal-actions');
            actions.innerHTML = '<span class="status-badge status-rejected">Rejected</span>';
            card.style.borderLeft = '4px solid var(--error)';
        }

        // Form Handlers
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);
            data.dietary_preferences = formData.getAll('dietary_preferences');
            data.fitness_goals = formData.getAll('fitness_goals');

            try {
                const res = await fetch(`${API_BASE}/api/profile`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast('Profile saved successfully! üë§', 'success');
                } else {
                    showToast('Error: ' + (result.error || 'Failed to save profile'), 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        });

        document.getElementById('progressForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData);

            try {
                const res = await fetch(`${API_BASE}/api/progress`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    showToast('Progress logged successfully! üìä', 'success');
                    e.target.reset();
                } else {
                    showToast('Error: ' + (result.error || 'Failed to log progress'), 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        });

        async function getProgressSummary() {
            showLoading('progressResult');
            try {
                const res = await fetch(`${API_BASE}/api/progress/summary`);
                const result = await res.json();
                if (result.success && result.summary) {
                    const summary = result.summary;
                    
                    // Helper function to format trend
                    const formatTrend = (value, unit, inverse = false) => {
                        if (value === null || value === undefined) return { text: 'N/A', class: 'neutral', icon: '‚ûñ' };
                        const isPositive = inverse ? value < 0 : value > 0;
                        const isNegative = inverse ? value > 0 : value < 0;
                        return {
                            text: `${value > 0 ? '+' : ''}${value.toFixed(1)}${unit}`,
                            class: isPositive ? 'positive' : (isNegative ? 'negative' : 'neutral'),
                            icon: isPositive ? 'üìà' : (isNegative ? 'üìâ' : '‚ûñ')
                        };
                    };
                    
                    // Weight trend (inverse - negative is good for weight loss)
                    const weightTrend = formatTrend(summary.weight_trend_30d, ' kg', true);
                    
                    // Workout adherence
                    const adherence = summary.workout_adherence_7d || 0;
                    const adherenceClass = adherence >= 75 ? 'positive' : (adherence >= 50 ? 'neutral' : 'negative');
                    
                    // Average calories
                    const avgCalories = summary.average_calories_7d ? Math.round(summary.average_calories_7d) : 'N/A';
                    
                    // Create mini bar chart for adherence
                    const createMiniBar = (value, max = 100) => {
                        const percentage = Math.min((value / max) * 100, 100);
                        const color = percentage >= 75 ? '#22c55e' : (percentage >= 50 ? '#eab308' : '#ef4444');
                        return `
                            <div style="width: 100%; height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; margin-top: 8px;">
                                <div style="width: ${percentage}%; height: 100%; background: ${color}; border-radius: 4px; transition: width 0.5s ease;"></div>
                            </div>
                        `;
                    };
                    
                    // Display summary with 5 metrics
                    document.getElementById('progressResult').innerHTML = `
                        <div style="margin-top: var(--spacing-lg);">
                            <!-- Metric Cards Grid -->
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                                <!-- Current Weight -->
                                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid #bae6fd;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">‚öñÔ∏è Current Weight</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #0369a1;">${summary.latest_weight ? summary.latest_weight.toFixed(1) + ' kg' : 'N/A'}</div>
                                    <div style="font-size: 0.75rem; color: ${weightTrend.class === 'positive' ? '#16a34a' : (weightTrend.class === 'negative' ? '#dc2626' : 'var(--text-secondary)')}; margin-top: 4px;">
                                        ${weightTrend.icon} ${weightTrend.text} (30d)
                                    </div>
                                </div>
                                
                                <!-- Workout Adherence -->
                                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid #86efac;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">üí™ Workout Adherence</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #16a34a;">${adherence.toFixed(0)}%</div>
                                    ${createMiniBar(adherence)}
                                </div>
                                
                                <!-- Average Calories -->
                                <div style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid #fde047;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">üî• Avg Daily Calories</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #ca8a04;">${avgCalories}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">Last 7 days</div>
                                </div>
                                
                                <!-- Total Entries -->
                                <div style="background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: 1px solid #e879f9;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 4px;">üìù Total Entries</div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #a21caf;">${summary.total_entries || 0}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 4px;">Progress logs</div>
                                </div>
                            </div>
                            
                            <!-- Consistency Score -->
                            <div style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); padding: var(--spacing-xl); border-radius: var(--radius-lg); color: white; text-align: center;">
                                <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 8px;">üèÜ Consistency Score</div>
                                <div style="font-size: 2.5rem; font-weight: 700;">${calculateConsistencyScore(summary)}</div>
                                <div style="font-size: 0.75rem; opacity: 0.8; margin-top: 8px;">${getConsistencyMessage(calculateConsistencyScore(summary))}</div>
                            </div>
                            
                            <!-- Tips Section -->
                            <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg); border-radius: var(--radius); border-left: 4px solid var(--primary);">
                                <div style="font-weight: 600; margin-bottom: 8px;">üí° Tips to Improve</div>
                                <ul style="margin: 0; padding-left: var(--spacing-lg); color: var(--text-secondary); font-size: 0.875rem;">
                                    ${generateTips(summary)}
                                </ul>
                            </div>
                        </div>
                    `;
                } else {
                    showError('progressResult', result.error || 'No progress data found. Start logging your progress!');
                }
            } catch (error) {
                showError('progressResult', error.message);
            }
        }
        
        function calculateConsistencyScore(summary) {
            let score = 0;
            let factors = 0;
            
            // Weight tracking (20 points)
            if (summary.latest_weight) {
                score += 20;
            }
            factors++;
            
            // Workout adherence (40 points)
            if (summary.workout_adherence_7d !== null) {
                score += Math.min(40, (summary.workout_adherence_7d / 100) * 40);
            }
            factors++;
            
            // Calorie tracking (20 points)
            if (summary.average_calories_7d) {
                score += 20;
            }
            factors++;
            
            // Total entries bonus (20 points)
            if (summary.total_entries >= 7) {
                score += 20;
            } else if (summary.total_entries >= 3) {
                score += 10;
            }
            factors++;
            
            return Math.round(score);
        }
        
        function getConsistencyMessage(score) {
            if (score >= 80) return "Outstanding! You're crushing it! üåü";
            if (score >= 60) return "Great progress! Keep it up! üí™";
            if (score >= 40) return "Good start! Stay consistent! üéØ";
            if (score >= 20) return "Getting there! Log more progress! üìä";
            return "Start logging to see your score! üöÄ";
        }
        
        function generateTips(summary) {
            const tips = [];
            
            if (!summary.latest_weight) {
                tips.push('<li>Log your weight regularly to track changes</li>');
            }
            
            if (summary.workout_adherence_7d !== null && summary.workout_adherence_7d < 75) {
                tips.push('<li>Try to complete at least 4 workouts per week</li>');
            }
            
            if (!summary.average_calories_7d) {
                tips.push('<li>Track your daily calories for better insights</li>');
            }
            
            if (summary.total_entries < 7) {
                tips.push('<li>Log progress daily for accurate tracking</li>');
            }
            
            if (summary.weight_trend_30d && summary.weight_trend_30d > 2) {
                tips.push('<li>Consider adjusting your calorie intake</li>');
            }
            
            if (tips.length === 0) {
                tips.push('<li>You\'re doing great! Keep up the consistency!</li>');
            }
            
            return tips.join('');
        }

        // Progress History Functions
        async function loadProgressHistory() {
            showLoading('progressHistory');
            try {
                const res = await fetch(`${API_BASE}/api/progress/entries`);
                const result = await res.json();
                
                if (result.success && result.entries && result.entries.length > 0) {
                    let html = '<div style="margin-top: var(--spacing-lg);">';
                    
                    result.entries.forEach((entry, index) => {
                        const entryDate = new Date(entry.date);
                        const dateStr = entryDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                        const isToday = entry.date === new Date().toISOString().split('T')[0];
                        
                        html += `
                            <div class="day-card" style="margin-bottom: var(--spacing-md);">
                                <div class="day-header" style="background: ${isToday ? 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)' : 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)'};">
                                    ${dateStr} ${isToday ? '(Today)' : ''}
                                </div>
                                <div id="progress-display-${index}" class="meal-summary" style="padding: var(--spacing-sm);">
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm); margin-bottom: var(--spacing-sm); font-size: 0.8rem;">
                                        <div style="text-align: center;"><span style="color: var(--text-secondary); font-size: 0.7rem;">Weight</span><br><strong style="font-size: 0.9rem;">${entry.weight_kg ? entry.weight_kg + ' kg' : '-'}</strong></div>
                                        <div style="text-align: center;"><span style="color: var(--text-secondary); font-size: 0.7rem;">Calories</span><br><strong style="font-size: 0.9rem;">${entry.calories_consumed || '-'}</strong></div>
                                        <div style="text-align: center;"><span style="color: var(--text-secondary); font-size: 0.7rem;">Workouts</span><br><strong style="font-size: 0.9rem;">${entry.workouts_completed || '-'}</strong></div>
                                        <div style="text-align: center;"><span style="color: var(--text-secondary); font-size: 0.7rem;">Meals</span><br><strong style="font-size: 0.9rem;">${entry.meals_followed || '-'}</strong></div>
                                        <div style="text-align: center;"><span style="color: var(--text-secondary); font-size: 0.7rem;">Energy</span><br><strong style="font-size: 0.9rem;">${entry.energy_rating ? entry.energy_rating + '/10' : '-'}</strong></div>
                                        <div style="text-align: center;"><span style="color: var(--text-secondary); font-size: 0.7rem;">Mood</span><br><strong style="font-size: 0.9rem;">${entry.mood_rating ? entry.mood_rating + '/10' : '-'}</strong></div>
                                    </div>

                                    <div style="display: flex; gap: var(--spacing-sm);">
                                        <button class="btn" style="flex: 1; font-size: 0.8rem; padding: var(--spacing-sm);" onclick="viewProgressEntry('${entry.date}')">View</button>
                                        <button class="btn" style="flex: 1; font-size: 0.8rem; padding: var(--spacing-sm); background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);" onclick="editProgressEntry('${entry.date}', ${index})">Edit</button>
                                    </div>
                                </div>
                                <div id="progress-edit-${index}" style="display: none; padding: var(--spacing-sm);">
                                    <form onsubmit="saveProgressEdit(event, '${entry.date}', ${index}); return false;">
                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-sm);">
                                            <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                                <label class="form-label" style="font-size: 0.75rem;">Weight (kg)</label>
                                                <input type="number" id="edit-progress-weight-${index}" class="form-input" style="padding: var(--spacing-sm); font-size: 0.85rem;" step="0.1" value="${entry.weight_kg || ''}">
                                            </div>
                                            <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                                <label class="form-label" style="font-size: 0.75rem;">Calories</label>
                                                <input type="number" id="edit-progress-calories-${index}" class="form-input" style="padding: var(--spacing-sm); font-size: 0.85rem;" value="${entry.calories_consumed || ''}">
                                            </div>
                                            <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                                <label class="form-label" style="font-size: 0.75rem;">Workouts</label>
                                                <input type="number" id="edit-progress-workouts-${index}" class="form-input" style="padding: var(--spacing-sm); font-size: 0.85rem;" value="${entry.workouts_completed || 0}" min="0">
                                            </div>
                                            <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                                <label class="form-label" style="font-size: 0.75rem;">Meals</label>
                                                <input type="number" id="edit-progress-meals-${index}" class="form-input" style="padding: var(--spacing-sm); font-size: 0.85rem;" value="${entry.meals_followed || 0}" min="0">
                                            </div>
                                            <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                                <label class="form-label" style="font-size: 0.75rem;">Energy (1-10)</label>
                                                <input type="number" id="edit-progress-energy-${index}" class="form-input" style="padding: var(--spacing-sm); font-size: 0.85rem;" value="${entry.energy_rating || ''}" min="1" max="10">
                                            </div>
                                            <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                                <label class="form-label" style="font-size: 0.75rem;">Mood (1-10)</label>
                                                <input type="number" id="edit-progress-mood-${index}" class="form-input" style="padding: var(--spacing-sm); font-size: 0.85rem;" value="${entry.mood_rating || ''}" min="1" max="10">
                                            </div>
                                        </div>
                                        <div class="form-group" style="margin-bottom: var(--spacing-sm);">
                                            <label class="form-label" style="font-size: 0.75rem;">Notes</label>
                                            <textarea id="edit-progress-notes-${index}" class="form-textarea" style="padding: var(--spacing-sm); font-size: 0.85rem;" rows="2">${entry.notes || ''}</textarea>
                                        </div>
                                        <div style="display: flex; gap: var(--spacing-sm);">
                                            <button type="submit" class="btn" style="flex: 1; font-size: 0.8rem; padding: var(--spacing-sm);">Save</button>
                                            <button type="button" class="btn btn-secondary" style="flex: 1; font-size: 0.8rem; padding: var(--spacing-sm);" onclick="cancelProgressEdit(${index})">Cancel</button>
                                            <button type="button" class="btn" style="flex: 0.5; font-size: 0.8rem; padding: var(--spacing-sm); background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" onclick="deleteProgressEntry('${entry.date}')">üóëÔ∏è</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    document.getElementById('progressHistory').innerHTML = html;
                } else {
                    document.getElementById('progressHistory').innerHTML = `
                        <div style="text-align: center; padding: var(--spacing-xl); color: var(--text-secondary);">
                            <div style="font-size: 2rem; margin-bottom: var(--spacing-md);">üìù</div>
                            <p>No progress entries yet. Start logging your progress above!</p>
                        </div>
                    `;
                }
            } catch (error) {
                showError('progressHistory', error.message);
            }
        }
        
        function viewProgressEntry(dateStr) {
            // Show modal with detailed view
            fetch(`${API_BASE}/api/progress/${dateStr}`)
                .then(res => res.json())
                .then(result => {
                    if (result.success && result.entry) {
                        const entry = result.entry;
                        const entryDate = new Date(entry.date);
                        const dateDisplay = entryDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
                        
                        let content = `
                            <div style="text-align: center; margin-bottom: var(--spacing-lg);">
                                <div style="font-size: 1.5rem; margin-bottom: var(--spacing-sm);">üìÖ <strong>${dateDisplay}</strong></div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--spacing-md);">
                        `;
                        
                        if (entry.weight_kg) {
                            content += `
                                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: var(--spacing-md); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">‚öñÔ∏è Weight</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #0369a1;">${entry.weight_kg} kg</div>
                                </div>
                            `;
                        }
                        
                        if (entry.calories_consumed) {
                            content += `
                                <div style="background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); padding: var(--spacing-md); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">üî• Calories</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #ca8a04;">${entry.calories_consumed}</div>
                                </div>
                            `;
                        }
                        
                        if (entry.workouts_completed) {
                            content += `
                                <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: var(--spacing-md); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">üí™ Workouts</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #16a34a;">${entry.workouts_completed}</div>
                                </div>
                            `;
                        }
                        
                        if (entry.meals_followed) {
                            content += `
                                <div style="background: linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%); padding: var(--spacing-md); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">üçΩÔ∏è Meals Followed</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #a21caf;">${entry.meals_followed}</div>
                                </div>
                            `;
                        }
                        
                        if (entry.energy_rating) {
                            content += `
                                <div style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); padding: var(--spacing-md); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">‚ö° Energy Level</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #ea580c;">${entry.energy_rating}/10</div>
                                </div>
                            `;
                        }
                        
                        if (entry.mood_rating) {
                            content += `
                                <div style="background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%); padding: var(--spacing-md); border-radius: var(--radius); text-align: center;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">üòä Mood</div>
                                    <div style="font-size: 1.25rem; font-weight: 700; color: #dc2626;">${entry.mood_rating}/10</div>
                                </div>
                            `;
                        }
                        
                        content += '</div>';
                        
                        if (entry.notes) {
                            content += `
                                <div style="margin-top: var(--spacing-lg); padding: var(--spacing-md); background: var(--bg); border-radius: var(--radius); border-left: 4px solid var(--primary);">
                                    <div style="font-weight: 600; margin-bottom: 8px;">üìù Notes</div>
                                    <p style="color: var(--text-secondary); margin: 0;">${entry.notes}</p>
                                </div>
                            `;
                        }
                        
                        showModal('Progress Details', content);
                    } else {
                        showToast('Error loading entry', 'error');
                    }
                })
                .catch(error => {
                    showToast('Error: ' + error.message, 'error');
                });
        }
        
        function editProgressEntry(dateStr, index) {
            document.getElementById(`progress-display-${index}`).style.display = 'none';
            document.getElementById(`progress-edit-${index}`).style.display = 'block';
        }
        
        function cancelProgressEdit(index) {
            document.getElementById(`progress-display-${index}`).style.display = 'block';
            document.getElementById(`progress-edit-${index}`).style.display = 'none';
        }
        
        async function saveProgressEdit(event, dateStr, index) {
            event.preventDefault();
            
            const data = {
                weight_kg: document.getElementById(`edit-progress-weight-${index}`).value,
                calories_consumed: document.getElementById(`edit-progress-calories-${index}`).value,
                workouts_completed: document.getElementById(`edit-progress-workouts-${index}`).value,
                meals_followed: document.getElementById(`edit-progress-meals-${index}`).value,
                energy_rating: document.getElementById(`edit-progress-energy-${index}`).value,
                mood_rating: document.getElementById(`edit-progress-mood-${index}`).value,
                notes: document.getElementById(`edit-progress-notes-${index}`).value
            };
            
            try {
                const res = await fetch(`${API_BASE}/api/progress/${dateStr}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                
                if (result.success) {
                    showToast('Progress entry updated! üìä', 'success');
                    loadProgressHistory(); // Reload the list
                } else {
                    showToast('Error: ' + (result.error || 'Failed to update'), 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }
        
        async function deleteProgressEntry(dateStr) {
            if (!confirm('Are you sure you want to delete this progress entry?')) {
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/progress/${dateStr}`, {
                    method: 'DELETE'
                });
                const result = await res.json();
                
                if (result.success) {
                    showToast('Progress entry deleted! üóëÔ∏è', 'success');
                    loadProgressHistory(); // Reload the list
                } else {
                    showToast('Error: ' + (result.error || 'Failed to delete'), 'error');
                }
            } catch (error) {
                showToast('Error: ' + error.message, 'error');
            }
        }

        // Save Plan Button Functions
        function createSaveButton(planId, planType) {
            return `
                <div class="plan-save-actions">
                    <button 
                        class="btn-save-plan" 
                        onclick="savePlanToDashboard('${planId}', '${planType}')"
                        data-plan-id="${planId}"
                        data-plan-type="${planType}"
                    >
                        üíæ Save to ${planType === 'meal' ? 'Meal' : 'Workout'} Plans
                    </button>
                    <button 
                        class="btn-regenerate" 
                        onclick="regeneratePlan('${planType}')"
                    >
                        üîÑ Regenerate
                    </button>
                </div>
            `;
        }

        async function savePlanToDashboard(planId, planType) {
            const button = document.querySelector(`[data-plan-id="${planId}"]`);
            if (!button) return;

            // Check if already saved
            if (button.classList.contains('saved')) {
                showToast('Plan already saved!', 'info');
                return;
            }

            // Set loading state
            button.classList.add('saving');
            button.disabled = true;
            const originalText = button.innerHTML;
            button.innerHTML = '‚è≥ Saving...';

            try {
                const res = await fetch(`${API_BASE}/api/chatbot/save-plan`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan_id: planId,
                        plan_type: planType,
                        user_id: 'default'
                    })
                });
                const result = await res.json();

                if (result.success) {
                    // Set saved state
                    button.classList.remove('saving');
                    button.classList.add('saved');
                    button.innerHTML = '‚úÖ Saved!';
                    
                    // Show success toast
                    showToast(
                        `‚úÖ ${planType === 'meal' ? 'Meal' : 'Workout'} plan saved! Click the ${planType === 'meal' ? 'üçΩÔ∏è Meals' : 'üí™ Workouts'} tab below to view it.`,
                        'success'
                    );

                    // Reload plans in background
                    if (planType === 'meal') {
                        loadMealPlans();
                        // Also refresh shopping list since meal plans changed
                        generateShoppingList();
                    } else if (planType === 'workout') {
                        loadWorkoutPlans();
                    }
                } else {
                    // Reset button on error
                    button.classList.remove('saving');
                    button.disabled = false;
                    button.innerHTML = originalText;
                    showToast('Failed to save plan: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                // Reset button on error
                button.classList.remove('saving');
                button.disabled = false;
                button.innerHTML = originalText;
                showToast('Error saving plan: ' + error.message, 'error');
            }
        }

        function regeneratePlan(planType) {
            const message = planType === 'meal' 
                ? 'Can you regenerate that meal plan with some variations?' 
                : 'Can you regenerate that workout plan with some variations?';
            
            document.getElementById('chatInput').value = message;
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }

        // Chatbot Functions
        async function sendChatMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            
            // Add user message with avatar
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.innerHTML = `
                <div class="message-avatar">üë§</div>
                <div class="message-bubble">
                    <div class="message-content">${escapeHtml(message)}</div>
                </div>
            `;
            chatMessages.appendChild(userMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Show typing indicator with avatar
            const typingMsg = document.createElement('div');
            typingMsg.className = 'chat-message assistant';
            typingMsg.id = 'typing-indicator';
            typingMsg.innerHTML = `
                <div class="message-avatar">ü§ñ</div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatMessages.appendChild(typingMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                const res = await fetch(`${API_BASE}/api/chatbot/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message, user_id: 'default' })
                });
                const result = await res.json();
                
                // Remove typing indicator
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
                
                // Format the message content
                let messageContent = formatMessage(result.response);
                
                // Check if this response contains a plan
                const hasPlan = result.plan_id && result.plan_type;
                
                // Add assistant response with avatar
                const assistantMsg = document.createElement('div');
                assistantMsg.className = 'chat-message assistant';
                assistantMsg.innerHTML = `
                    <div class="message-avatar">ü§ñ</div>
                    <div class="message-bubble">
                        <div class="message-content">${messageContent}</div>
                        ${hasPlan ? createSaveButton(result.plan_id, result.plan_type) : ''}
                    </div>
                `;
                chatMessages.appendChild(assistantMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                const indicator = document.getElementById('typing-indicator');
                if (indicator) indicator.remove();
                const errorMsg = document.createElement('div');
                errorMsg.className = 'chat-message assistant';
                errorMsg.innerHTML = `
                    <div class="message-avatar">‚ö†Ô∏è</div>
                    <div class="message-bubble" style="border-color: var(--error); background: #fee2e2;">
                        <div class="message-content">
                            <strong>Oops!</strong> I encountered an error: ${escapeHtml(error.message)}
                        </div>
                    </div>
                `;
                chatMessages.appendChild(errorMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function sendQuickMessage(message) {
            document.getElementById('chatInput').value = message;
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }

        function formatMessage(text) {
            // Convert markdown-style formatting to HTML
            text = escapeHtml(text);
            
            // Bold text
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Preserve emojis and special formatting
            text = text.replace(/üìä/g, '<span style="font-size: 1.25rem;">üìä</span>');
            text = text.replace(/üç≥/g, '<span class="meal-emoji">üç≥</span>');
            text = text.replace(/ü•ó/g, '<span class="meal-emoji">ü•ó</span>');
            text = text.replace(/üçΩÔ∏è/g, '<span class="meal-emoji">üçΩÔ∏è</span>');
            text = text.replace(/üçé/g, '<span class="meal-emoji">üçé</span>');
            text = text.replace(/üí™/g, '<span class="meal-emoji">üí™</span>');
            text = text.replace(/üò¥/g, '<span class="meal-emoji">üò¥</span>');
            
            // Format Day headers specially
            text = text.replace(/Day (\d+) \(([^)]+)\):/g, '<div class="meal-day"><strong>üìÖ Day $1</strong> ($2)</div>');
            
            // Line breaks
            text = text.replace(/\n\n/g, '<br><br>');
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }
        
        function isPlanResponse(text) {
            // Detect if the response contains a plan
            // Look for common plan indicators
            const planIndicators = [
                /Day \d+/i,
                /\d+ kcal/i,
                /Breakfast:|Lunch:|Dinner:|Snack:/i,
                /sets?\s*[√óx]\s*\d+\s*reps?/i,
                /Exercise \d+:/i,
                /Workout Day \d+/i
            ];
            
            return planIndicators.some(pattern => pattern.test(text));
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Chat form handler
        if (document.getElementById('chatForm')) {
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatInput');
            
            // Auto-resize textarea as user types
            function autoResizeTextarea() {
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            }
            
            chatInput.addEventListener('input', autoResizeTextarea);
            
            // Handle Enter key (submit) and Shift+Enter (new line)
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    chatForm.dispatchEvent(new Event('submit'));
                }
            });
            
            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const message = chatInput.value.trim();
                
                if (message) {
                    chatInput.value = '';
                    chatInput.style.height = 'auto'; // Reset height after sending
                    await sendChatMessage(message);
                }
            });
        }

        // Initialize - load meal plans on page load
        window.addEventListener('DOMContentLoaded', () => {
            // Load meal plans when page first loads (Profile tab is active by default)
            loadMealPlans();
            loadWorkoutPlans();
        });
    </script>
</body>

</html>